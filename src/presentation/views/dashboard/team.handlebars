<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-users me-2"></i>Team Management
                </h1>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inviteMemberModal">
                    <i class="fas fa-user-plus me-2"></i>Invite Team Member
                </button>
            </div>

            <!-- Team Members List -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Team Members</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Invited Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="teamMembersBody">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Loading State -->
                    <div class="text-center py-4" id="loadingState">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading team members...</p>
                    </div>

                    <!-- Empty State -->
                    <div class="text-center py-5 d-none" id="emptyState">
                        <div class="mb-3">
                            <i class="fas fa-users fa-3x text-muted"></i>
                        </div>
                        <h5 class="text-muted">No team members yet</h5>
                        <p class="text-muted mb-4">Start by inviting your first team member to collaborate.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inviteMemberModal">
                            <i class="fas fa-user-plus me-2"></i>Invite Team Member
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Invite Member Modal -->
<div class="modal fade" id="inviteMemberModal" tabindex="-1" aria-labelledby="inviteMemberModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inviteMemberModalLabel">
                    <i class="fas fa-user-plus me-2"></i>Invite Team Member
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="inviteMemberForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="inviteFirstName" class="form-label">First Name *</label>
                        <input type="text" class="form-control" id="firstName" name="firstName" required placeholder="">
                        <label for="inviteSurname" class="form-label">Surname *</label>
                        <input type="text" class="form-control" id="surname" name="surname" required placeholder="">
                        <label for="inviteEmail" class="form-label">Email Address *</label>
                        <input type="email" class="form-control" id="email" name="email" required
                            placeholder="team.member@company.com">
                        <div class="form-text">An invitation link will be sent to this email address.</div>
                    </div>

                    {{!-- <div class="mb-3">
                        <label for="inviteRole" class="form-label">Role *</label>
                        <select class="form-select" id="inviteRole" name="role" required>
                            <option value="">Select a role</option>
                            <option value="verifier">Verifier</option>
                            <option value="manager">Manager</option>
                            <option value="analyst">Analyst</option>
                            <option value="viewer">Viewer</option>
                        </select>
                        <div class="form-text">
                            <small>
                                <strong>Verifier:</strong> Can verify academic certificates<br>
                                <strong>Manager:</strong> Can manage team and view reports<br>
                                <strong>Analyst:</strong> Can view analytics and reports<br>
                                <strong>Viewer:</strong> Read-only access to certificates
                            </small>
                        </div>
                    </div> --}}

                    {{!-- <div class="mb-3">
                        <label class="form-label">Permissions</label>
                        <div class="border rounded p-3 bg-light">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="permissions" value="read"
                                            id="permRead" checked>
                                        <label class="form-check-label" for="permRead">
                                            <i class="fas fa-eye me-1"></i> Read Certificates
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="permissions"
                                            value="verify" id="permVerify">
                                        <label class="form-check-label" for="permVerify">
                                            <i class="fas fa-check-circle me-1"></i> Verify Certificates
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="permissions"
                                            value="create" id="permCreate">
                                        <label class="form-check-label" for="permCreate">
                                            <i class="fas fa-plus-circle me-1"></i> Create Records
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="permissions"
                                            value="update" id="permUpdate">
                                        <label class="form-check-label" for="permUpdate">
                                            <i class="fas fa-edit me-1"></i> Update Records
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="permissions"
                                            value="reports" id="permReports">
                                        <label class="form-check-label" for="permReports">
                                            <i class="fas fa-chart-bar me-1"></i> View Reports
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="permissions"
                                            value="export" id="permExport">
                                        <label class="form-check-label" for="permExport">
                                            <i class="fas fa-download me-1"></i> Export Data
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> --}}

                    <div class="mb-3">
                        <label for="customMessage" class="form-label">Custom Message (Optional)</label>
                        <textarea class="form-control" id="customMessage" name="customMessage" rows="2"
                            placeholder="Add a personal message to the invitation..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="inviteSubmitBtn">
                        <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
                        Send Invitation
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{{!-- View Member Modal --}}
<div class="modal fade" id="memberDetailsModal" tabindex="-1" aria-labelledby="memberDetailsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="memberDetailsModalLabel">
                    <i class="fas fa-user me-2"></i>Member Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-4">
                        <div class="avatar bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center"
                            style="width: 100px; height: 100px; font-size: 2rem; font-weight: 600;">
                            ${getInitials(member.email)}
                        </div>
                        <h5 class="mt-3">${member.firstName && member.surname ? `${member.firstName} ${member.surname}`
                            : member.email.split('@')[0]}</h5>
                        <p class="text-muted">${member.email}</p>
                        <span class="badge ${getRoleBadgeColor(member.role)} fs-6">
                            ${capitalizeFirst(member.role)}
                        </span>
                    </div>
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label fw-semibold">First Name</label>
                                <p>${member.firstName || 'N/A'}</p>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label fw-semibold">Surname</label>
                                <p>${member.surname || 'N/A'}</p>
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label fw-semibold">Email</label>
                                <p>${member.email}</p>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label fw-semibold">Role</label>
                                <p>${capitalizeFirst(member.role)}</p>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label fw-semibold">Status</label>
                                <p>
                                    <span class="badge ${getStatusBadgeColor(member.isVerified)}">
                                        <i class="fas ${getStatusIcon(member.isVerified)} me-1"></i>
                                        ${member.isVerified ? 'Verified' : 'Not Verified'}
                                    </span>
                                </p>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label fw-semibold">Invited Date</label>
                                <p>${formatDate(member.createdAt)}</p>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label fw-semibold">Last Active</label>
                                <p>${member.lastActive ? formatDate(member.lastActive) : 'N/A'}</p>
                            </div>
                        </div>

                        ${member.permissions ? `
                        <div class="mt-3">
                            <label class="form-label fw-semibold">Permissions</label>
                            <div class="border rounded p-3 bg-light">
                                <div class="row">
                                    ${renderPermissions(member.permissions)}
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        ${member.lastLogin ? `
                        <div class="mt-3">
                            <label class="form-label fw-semibold">Last Login</label>
                            <p>${formatDateTime(member.lastLogin)}</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                ${member.isVerified === false ? `
                <button type="button" class="btn btn-warning" onclick="resendInvitation('${member.email}')">
                    <i class="fas fa-paper-plane me-2"></i>Resend Invitation
                </button>
                ` : ''}
                <button type="button" class="btn btn-danger"
                    onclick="removeTeamMember('${member.id}', '${member.email}')">
                    <i class="fas fa-trash me-2"></i>Remove Member
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="fas fa-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="successToastMessage"></div>
    </div>

    <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong class="me-auto">Error</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="errorToastMessage"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const teamMembersBody = document.getElementById('teamMembersBody');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const inviteMemberForm = document.getElementById('inviteMemberForm');
        const inviteSubmitBtn = document.getElementById('inviteSubmitBtn');

        // Toast elements
        const successToast = new bootstrap.Toast(document.getElementById('successToast'));
        const successToastMessage = document.getElementById('successToastMessage');
        const errorToast = new bootstrap.Toast(document.getElementById('errorToast'));
        const errorToastMessage = document.getElementById('errorToastMessage');

        // Load team members on page load
        loadTeamMembers();
        // Remove existing modal if any
        const existingModal = document.getElementById('memberDetailsModal');
        if (existingModal) {
            existingModal.remove();
        }

        // Add modal to DOM
        // document.body.insertAdjacentHTML('beforeend', modalHTML);



        // Clean up modal on hide

        // Form submission handler
        inviteMemberForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const permissions = Array.from(formData.getAll('permissions'));

            const payload = {
                firstName: formData.get('firstName'),
                surname: formData.get('surname'),
                email: formData.get('email'),
                //role: formData.get('role'),
                // permissions: permissions,
                customMessage: formData.get('customMessage')
            };

            await inviteTeamMember(payload);
        });

        // Auto-set permissions based on role selection
        //document.getElementById('inviteRole').addEventListener('change', function() {
        //  setPermissionsByRole(this.value);
        //});

        async function loadTeamMembers() {
            try {
                const response = await fetch('/api/team/members', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch team members');
                }

                const result = await response.json();

                if (result.success) {
                    displayTeamMembers(result.data);
                } else {
                    showError('Failed to load team members: ' + results.message);
                    window.location.href = '/auth/login';
                }
            } catch (error) {

                showError('Failed to load team members: ' + error.message);
                loadingState.classList.add('d-none');
                emptyState.classList.remove('d-none');
            }
        }

        function displayTeamMembers(members) {
            loadingState.classList.add('d-none');

            if (!members || members.length === 0) {
                emptyState.classList.remove('d-none');
                teamMembersBody.innerHTML = '';
                return;
            }

            emptyState.classList.add('d-none');

            teamMembersBody.innerHTML = members.map(member => `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                             style="width: 40px; height: 40px; font-weight: 600;">
                            ${getInitials(member.email)}
                        </div>
                        <div>
                            <div class="fw-semibold">${member.firstName.concat(' ', member.surname) || member.email.split('@')[0]}</div>
                            ${member.firstName ? `<small class="text-muted">${member.email}</small>` : ''}
                        </div>
                    </div>
                </td>
                <td>${member.email}</td>
                <td>
                    <span class="badge ${getRoleBadgeColor(member.role)}">
                        ${capitalizeFirst(member.role)}
                    </span>
                </td>
                <td>
                    <span class="badge ${getStatusBadgeColor(member.isVerified)}">
                        <i class="fas ${getStatusIcon(member.isVerified)} me-1"></i>
                        ${member.isVerified ? 'Verfied' : 'Not Verified'}
                    </span>
                </td>
                <td>
                    <small class="text-muted">${formatDate(member.createdAt)}</small>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        ${member.isVerified === false ? `
                            <button class="btn btn-outline-warning" onclick="resendInvitation('${member.email}')" 
                                    title="Resend Invitation">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-outline-secondary" onclick="viewMemberDetails('${member.id}')" 
                                title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="removeTeamMember('${member.id}', '${member.email}')" 
                                title="Remove Member">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
        }

        async function inviteTeamMember(payload) {

            const originalContent = inviteSubmitBtn.innerHTML;

            try {
                // Show loading state
                // spinner.classList.remove('d-none');
                inviteSubmitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Sending...';
                // buttonText.textContent = 'Sending...';
                inviteSubmitBtn.disabled = true;

                const response = await fetch('/api/team/invite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess('Invitation sent successfully!');
                    // Close modal and reset form
                    bootstrap.Modal.getInstance(document.getElementById('inviteMemberModal')).hide();
                    inviteMemberForm.reset();
                    // Refresh the team members list
                    loadTeamMembers();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error inviting team member:', error);
                showError('Failed to send invitation: ' + error.message);
            } finally {
                // Reset button state
                inviteSubmitBtn.innerHTML = originalContent;
                inviteSubmitBtn.disabled = false;
            }
        }

        function setPermissionsByRole(role) {
            const permissions = {
                read: document.getElementById('permRead'),
                verify: document.getElementById('permVerify'),
                create: document.getElementById('permCreate'),
                update: document.getElementById('permUpdate'),
                reports: document.getElementById('permReports'),
                export: document.getElementById('permExport')
            };

            // Reset all permissions
            Object.values(permissions).forEach(checkbox => {
                checkbox.checked = false;
            });

            // Set permissions based on role
            switch (role) {
                case 'verifier':
                    permissions.read.checked = true;
                    permissions.verify.checked = true;
                    permissions.reports.checked = true;
                    break;
                case 'manager':
                    permissions.read.checked = true;
                    permissions.verify.checked = true;
                    permissions.create.checked = true;
                    permissions.update.checked = true;
                    permissions.reports.checked = true;
                    permissions.export.checked = true;
                    break;
                case 'analyst':
                    permissions.read.checked = true;
                    permissions.reports.checked = true;
                    permissions.export.checked = true;
                    break;
                case 'viewer':
                    permissions.read.checked = true;
                    break;
            }
        }

        // Helper functions
        function getInitials(email) {
            return email
                .split('@')[0]
                .split('.')
                .map(part => part.charAt(0).toUpperCase())
                .join('')
                .substring(0, 2);
        }

        function getRoleBadgeColor(role) {
            const colors = {
                member: 'bg-primary',
                manager: 'bg-warning',
                analyst: 'bg-info',
                viewer: 'bg-secondary'
            };
            return colors[role] || 'bg-secondary';
        }

        function getStatusBadgeColor(status) {
            const colors = {
                true: 'bg-success',
                pending: 'bg-warning',
                false: 'bg-secondary'
            };
            return colors[status] || 'bg-secondary';
        }

        function getStatusIcon(status) {
            const icons = {
                true: 'fa-check-circle',
                pending: 'fa-clock',
                false: 'fa-ban'
            };
            return icons[status] || 'fa-question-circle';
        }

        function capitalizeFirst(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function showSuccess(message) {
            successToastMessage.textContent = message;
            successToast.show();
        }

        function showError(message) {
            errorToastMessage.textContent = message;
            errorToast.show();
        }

        // Global functions for action buttons
        window.resendInvitation = async function (email) {
            if (confirm('Resend invitation to this team member?')) {
                try {
                    const response = await fetch(`/api/team/resend-invitation/${email}`, {
                        method: 'POST',
                        credentials: 'include'
                    });

                    const result = await response.json();

                    if (result.success) {
                        showSuccess('Invitation resent successfully!');
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    console.error('Error resending invitation:', error);
                    showError('Failed to resend invitation: ' + error.message);
                }
            }
        };

        window.viewMemberDetails = function (memberId) {
            // Implement view details functionality
            showSuccess('View details for member: ' + memberId);

            try {
                // Try to get existing instance
              

                 bootstrap.Modal.getInstance(document.getElementById('memberDetailsModal')).show();
                   
            } catch (error) {
                console.error('Error showing modal:', error);

                // Fallback: Remove any existing backdrop and show manually
                const existingBackdrop = document.querySelector('.modal-backdrop');
                if (existingBackdrop) {
                    existingBackdrop.remove();
                }

            }
        };

        window.removeTeamMember = async function (memberId, email) {
            if (confirm(`Are you sure you want to remove ${email} from your team? This action cannot be undone.`)) {
                try {
                    const response = await fetch(`/api/team/remove/${memberId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        credentials: 'include'
                    });

                    const result = await response.json();

                    if (result.success) {
                        showSuccess('Team member removed successfully!');
                        loadTeamMembers(); // Refresh the list
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    console.error('Error removing team member:', error);
                    showError('Failed to remove team member: ' + error.message);
                }
            }
        };
    });
</script>

<style>
    .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .table th {
        border-top: none;
        font-weight: 600;
        color: #6c757d;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-group-sm>.btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }

    .toast {
        z-index: 9999;
    }

    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }
</style>