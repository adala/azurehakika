{{! viewall-transactions.handlebars - For use within main layout }}
<div class="viewall-transactions-page">
    <!-- Header with Actions -->
    <div class="page-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2">Transactions</h1>
                <p class="text-muted mb-0">Monitor and manage all financial transactions</p>
            </div>
            <div class="action-buttons">
                <div class="btn-group" role="group">
                    {{!-- <button class="btn btn-primary" id="newTransactionBtn">
                        <i class="fas fa-plus me-2"></i>Add Transaction
                    </button> --}}
                    <button class="btn btn-primary" id="refundBtn">
                        <i class="fas fa-undo me-2"></i>Process Refund
                    </button>
                    <button class="btn btn-outline-primary" id="exportReportBtn">
                        <i class="fas fa-file-export me-2"></i>Export Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Financial Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Topups</h6>
                            <h3 class="mb-0" id="totalTopups">$0</h3>
                            <small class="opacity-75">Total</small>
                        </div>
                        <i class="fas fa-money-bill-wave fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Withdrawals</h6>
                            <h3 class="mb-0" id="totalWithdrawals">$0</h3>
                            <small class="opacity-75">Total</small>
                        </div>
                        <i class="fas fa-clock fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Current Balance</h6>
                            <h3 class="mb-0" id="totalRefunds">$0</h3>
                            <small class="opacity-75">Total</small>
                        </div>
                        <i class="fas fa-chart-line fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Transactions</h6>
                            <h3 class="mb-0" id="totalTransactions">0</h3>
                            <small class="opacity-75">Total processed</small>
                        </div>
                        <i class="fas fa-exchange-alt fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Date Range -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small text-muted">Date Range</label>
                    <select class="form-select" id="dateRange">
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="week" selected>This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted">Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="all">All Status</option>
                        <option value="completed">Completed</option>
                        <option value="pending">Pending</option>
                        <option value="failed">Failed</option>
                        <option value="refunded">Refunded</option>
                        <option value="disputed">Disputed</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted">Payment Method</label>
                    <select class="form-select" id="paymentMethodFilter">
                        <option value="all">All Methods</option>
                        <option value="card">Credit Card</option>
                        <option value="bank">Bank Transfer</option>
                        <option value="mobile">Mobile Money</option>
                        <option value="paypal">PayPal</option>
                    </select>
                </div>
                {{!-- <div class="col-md-3">
                    <label class="form-label small text-muted">Institution</label>
                    <select class="form-select" id="institutionFilter">
                        <option value="all">All Institutions</option>
                        <!-- Will be populated dynamically -->
                    </select>
                </div> --}}
            </div>
            <!-- Custom Date Range (hidden by default) -->
            <div class="row g-3 mt-3 d-none" id="customDateRange">
                <div class="col-md-3">
                    <label class="form-label small text-muted">From Date</label>
                    <input type="date" class="form-control" id="fromDate">
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted">To Date</label>
                    <input type="date" class="form-control" id="toDate">
                </div>
                <div class="col-md-3 align-self-end">
                    <button class="btn btn-primary w-100" id="applyDateRange">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transactions Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Transaction History</h5>
            <div class="d-flex align-items-center gap-2">
                <div class="input-group input-group-sm" style="width: 200px;">
                    <input type="text" class="form-control" placeholder="Search..." id="tableSearch">
                    <button class="btn btn-outline-secondary" type="button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="transactionsTable">
                    <thead>
                        <tr>
                            <th>Transaction ID</th>
                            <th>Date & Time</th>
                            <th>Description</th>
                            <th>Verification ID</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Payment Method</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted small">
                    Showing <span id="startCount">0</span> to <span id="endCount">0</span> of <span
                        id="totalItems">0</span> transactions
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="pagination">
                        <!-- Pagination will be generated here -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Transaction Summary -->
    {{!-- <div class="row mt-4">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Transaction Summary</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="summary-item mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">Total Processed</span>
                                    <span class="fw-bold" id="summaryTotal">$0</span>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-success" style="width: 100%"></div>
                                </div>
                            </div>
                            <div class="summary-item mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">Fees</span>
                                    <span class="fw-bold" id="summaryFees">$0</span>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-warning" style="width: 15%"></div>
                                </div>
                            </div>
                            <div class="summary-item mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">Net Revenue</span>
                                    <span class="fw-bold" id="summaryNet">$0</span>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-primary" style="width: 85%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="status-distribution">
                                <h6 class="text-muted mb-3">Status Distribution</h6>
                                <div class="distribution-item d-flex justify-content-between mb-2">
                                    <span>
                                        <span class="status-indicator status-completed me-2"></span>
                                        Completed
                                    </span>
                                    <span class="fw-bold" id="countCompleted">0</span>
                                </div>
                                <div class="distribution-item d-flex justify-content-between mb-2">
                                    <span>
                                        <span class="status-indicator status-pending me-2"></span>
                                        Pending
                                    </span>
                                    <span class="fw-bold" id="countPending">0</span>
                                </div>
                                <div class="distribution-item d-flex justify-content-between mb-2">
                                    <span>
                                        <span class="status-indicator status-failed me-2"></span>
                                        Failed
                                    </span>
                                    <span class="fw-bold" id="countFailed">0</span>
                                </div>
                                <div class="distribution-item d-flex justify-content-between">
                                    <span>
                                        <span class="status-indicator status-refunded me-2"></span>
                                        Refunded
                                    </span>
                                    <span class="fw-bold" id="countRefunded">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div> --}}

    <!-- Add Transaction Modal -->
    <div class="modal fade" id="addTransactionModal" tabindex="-1" aria-labelledby="addTransactionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTransactionModalLabel">
                        <i class="fas fa-plus-circle me-2"></i>Add New Transaction
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addTransactionForm">
                        <div class="row g-3">
                            <!-- Transaction Type -->
                            <div class="col-md-6">
                                <label for="transactionType" class="form-label">
                                    <i class="fas fa-exchange-alt me-1"></i>Transaction Type
                                </label>
                                <select class="form-select" id="transactionType" name="type" required>
                                    <option value="">Select type...</option>
                                    <option value="payment">Payment</option>
                                    <option value="refund">Refund</option>
                                    <option value="topup">Top-up</option>
                                    <option value="fee">Fee</option>
                                    <option value="verification_fee">Verification Fee</option>
                                    <option value="adjustment">Adjustment</option>
                                </select>
                            </div>

                            <!-- Amount -->
                            <div class="col-md-6">
                                <label for="transactionAmount" class="form-label">
                                    <i class="fas fa-dollar-sign me-1"></i>Amount
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="transactionAmount" name="amount"
                                        step="0.01" min="0" placeholder="0.00" required>
                                </div>
                            </div>

                            <!-- Payment Method -->
                            <div class="col-md-6">
                                <label for="paymentMethod" class="form-label">
                                    <i class="fas fa-credit-card me-1"></i>Payment Method
                                </label>
                                <select class="form-select" id="paymentMethod" name="paymentMethod" required>
                                    <option value="">Select method...</option>
                                    <option value="card">Credit/Debit Card</option>
                                    <option value="bank">Bank Transfer</option>
                                    <option value="mobile">Mobile Money</option>
                                    <option value="paypal">PayPal</option>
                                    <option value="mpesa">M-Pesa</option>
                                    <option value="cash">Cash</option>
                                    <option value="online">Online Payment</option>
                                </select>
                            </div>

                            <!-- Currency -->
                            <div class="col-md-6">
                                <label for="currency" class="form-label">
                                    <i class="fas fa-globe me-1"></i>Currency
                                </label>
                                <select class="form-select" id="currency" name="currency" required>
                                    <option value="USD" selected>USD - US Dollar</option>
                                    <option value="KES">KES - Kenyan Shilling</option>
                                    <option value="UGX">UGX - Ugandan Shilling</option>
                                    <option value="TZS">TZS - Tanzanian Shilling</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="GBP">GBP - British Pound</option>
                                </select>
                            </div>

                            <!-- Status -->
                            <div class="col-md-6">
                                <label for="transactionStatus" class="form-label">
                                    <i class="fas fa-check-circle me-1"></i>Status
                                </label>
                                <select class="form-select" id="transactionStatus" name="status" required>
                                    <option value="pending">Pending</option>
                                    <option value="completed" selected>Completed</option>
                                    <option value="failed">Failed</option>
                                    <option value="refunded">Refunded</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>

                            <!-- Verification Link -->
                            <div class="col-md-6">
                                <label for="verificationId" class="form-label">
                                    <i class="fas fa-link me-1"></i>Link to Verification
                                </label>
                                <select class="form-select" id="verificationId" name="verificationId">
                                    <option value="">Not linked</option>
                                    <!-- Will be populated dynamically -->
                                </select>
                            </div>

                            <!-- Description -->
                            <div class="col-12">
                                <label for="description" class="form-label">
                                    <i class="fas fa-align-left me-1"></i>Description
                                </label>
                                <textarea class="form-control" id="description" name="description" rows="3"
                                    placeholder="Enter transaction description..." maxlength="255"></textarea>
                                <div class="form-text">Maximum 255 characters</div>
                            </div>

                            <!-- Transaction Date -->
                            <div class="col-md-6">
                                <label for="transactionDate" class="form-label">
                                    <i class="fas fa-calendar me-1"></i>Transaction Date
                                </label>
                                <input type="datetime-local" class="form-control" id="transactionDate" name="createdAt"
                                    required>
                            </div>

                            <!-- Reference Number -->
                            <div class="col-md-6">
                                <label for="referenceNumber" class="form-label">
                                    <i class="fas fa-hashtag me-1"></i>Reference Number
                                </label>
                                <input type="text" class="form-control" id="referenceNumber" name="referenceNumber"
                                    placeholder="e.g., TXN-2024-001">
                                <div class="form-text">Leave blank to auto-generate</div>
                            </div>

                            <!-- Metadata -->
                            <div class="col-12">
                                <div class="accordion" id="metadataAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#metadataCollapse">
                                                <i class="fas fa-cog me-2"></i>Additional Metadata
                                            </button>
                                        </h2>
                                        <div id="metadataCollapse" class="accordion-collapse collapse"
                                            data-bs-parent="#metadataAccordion">
                                            <div class="accordion-body">
                                                <div class="row g-2">
                                                    <div class="col-md-6">
                                                        <label for="gatewayReference" class="form-label small">Gateway
                                                            Reference</label>
                                                        <input type="text" class="form-control form-control-sm"
                                                            id="gatewayReference" name="gatewayReference">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="payerEmail" class="form-label small">Payer
                                                            Email</label>
                                                        <input type="email" class="form-control form-control-sm"
                                                            id="payerEmail" name="payerEmail">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="payerName" class="form-label small">Payer
                                                            Name</label>
                                                        <input type="text" class="form-control form-control-sm"
                                                            id="payerName" name="payerName">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="payerPhone" class="form-label small">Payer
                                                            Phone</label>
                                                        <input type="text" class="form-control form-control-sm"
                                                            id="payerPhone" name="payerPhone">
                                                    </div>
                                                    <div class="col-12">
                                                        <label for="notes" class="form-label small">Internal
                                                            Notes</label>
                                                        <textarea class="form-control form-control-sm" id="notes"
                                                            name="notes" rows="2"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveTransactionBtn">
                        <i class="fas fa-save me-2"></i>Save Transaction
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Empty State Template -->
<template id="emptyStateTemplate">
    <tr>
        <td colspan="8">
            <div class="text-center py-5">
                <i class="fas fa-exchange-alt fa-4x text-muted mb-3"></i>
                <h5 class="text-muted mb-3">No transactions found</h5>
                <p class="text-muted mb-4">Transactions will appear here once they are processed</p>
                <a href="/verifications/new" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Start a Verification
                </a>
            </div>
        </td>
    </tr>
</template>

<!-- Row Template -->
<template id="transactionRowTemplate">
    <tr data-id="{{id}}" class="transaction-row">
        <td>
            <div>
                <strong class="d-block transaction-id">{{transactionId}}</strong>
                {{!-- <small class="text-muted reference-number">{{referenceNumber}}</small> --}}
            </div>
        </td>
        <td>
            <div>
                <div class="d-block transaction-date">{{formatDate createdAt}}</div>
                <small class="text-muted transaction-time">{{formatTime createdAt}}</small>
            </div>
        </td>
        <td>
            <div>
                <div class="d-block transaction-description">{{description}}</div>
                <small class="text-muted payment-method-text">{{paymentMethod}}</small>
            </div>
        </td>
        <td class="verification-cell">
            {{#if Verification}}
            <a href="/verifications/{{id}}" class="text-decoration-none verification-link">
                #{{referenceNumber}}
            </a>
            {{else}}
            <span class="text-muted">-</span>
            {{/if}}
        </td>
        <td>
            <div class="amount-cell">
                <strong class="d-block amount-value {{#if (eq type 'refund')}}text-danger{{else}}text-success{{/if}}">
                    {{#if (eq type 'refund')}}-{{/if}}${{amount}}
                </strong>
                <small class="text-muted currency-code">{{currency}}</small>
            </div>
        </td>
        <td>
            <span class="status-badge status-badge-{{status}}">
                {{status}}
            </span>
            {{#if isRecurring}}
            <span class="badge bg-info ms-1 recurring-badge">Recurring</span>
            {{/if}}
        </td>
        <td>
            <div class="d-flex align-items-center">
                <i class="fas payment-method-icon {{paymentMethodIcon}} me-2 text-muted"></i>
                <span class="payment-method-display">{{paymentMethod}}</span>
            </div>
        </td>
        <td class="text-end">
            <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-primary view-btn" title="View Details"
                    data-transaction-id="{{transactionId}}">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item view-receipt-btn" href="#" data-transaction-id="{{transactionId}}">
                            <i class="fas fa-receipt me-2"></i>View Receipt
                        </a></li>
                    <li><a class="dropdown-item print-invoice-btn" href="#" data-transaction-id="{{transactionId}}">
                            <i class="fas fa-print me-2"></i>Print Invoice
                        </a></li>
                    <li><a class="dropdown-item share-btn" href="#" data-transaction-id="{{transactionId}}">
                            <i class="fas fa-share me-2"></i>Share
                        </a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    {{#if (eq status 'pending')}}
                    <li><a class="dropdown-item mark-paid-btn" href="#" data-transaction-id="{{transactionId}}">
                            <i class="fas fa-check me-2"></i>Mark as Paid
                        </a></li>
                    {{/if}}
                    {{#if (eq status 'completed')}}
                    <li><a class="dropdown-item text-warning refund-btn" href="#"
                            data-transaction-id="{{transactionId}}">
                            <i class="fas fa-undo me-2"></i>Refund
                        </a></li>
                    {{/if}}
                    <li><a class="dropdown-item text-danger delete-btn" href="#"
                            data-transaction-id="{{transactionId}}">
                            <i class="fas fa-trash me-2"></i>Delete
                        </a></li>
                </ul>
            </div>
        </td>
    </tr>
</template>

<!-- Transaction Details Modal -->
<div class="modal fade" id="transactionDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transaction Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="transactionDetailsContent">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="printReceiptBtn">
                    <i class="fas fa-print me-2"></i>Print Receipt
                </button>
            </div>
        </div>
    </div>
</div>


<script>
    const TransactionsService = {
        currentPage: 1,
        pageSize: 10,
        totalItems: 0,
        currentFilters: {
            dateRange: 'month',
            status: 'all',
            paymentMethod: 'all',
            institution: 'all'
        },

        async loadTransactions(page = 1) {
            try {
                const token = AuthService.getToken();
                if (!token) {
                    AuthService.redirectToLogin();
                    return;
                }

                const params = new URLSearchParams({
                    page: page,
                    limit: this.pageSize,
                    ...this.currentFilters
                });

                if (this.currentFilters.status !== 'all') {
                    params.append('status', this.currentFilters.status);
                }

                if (this.currentFilters.paymentMethod !== 'all') {
                    params.append('paymentMethod', this.currentFilters.paymentMethod);
                }

                if (this.currentFilters.institution !== 'all') {
                    params.append('institution', this.currentFilters.institution);
                }

                if (this.currentFilters.search) {
                    params.append('search', this.currentFilters.search);
                }

                // Handle date range
                this.addDateRangeParams(params);

                console.log('Loading transactions with params:', params.toString()); // Debug log

                const response = await fetch(`/transactions/recent?${params}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    this.renderTransactions(data);
                    this.updateSummary(data.stats);
                    this.updatePagination(data.pagination.total, page);
                    //   this.updateCounts(data.summary || data.stats || {});
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                showToast('error', 'Failed to load transactions');
            }
        },

        renderTransactions(data) {
            const tableBody = document.getElementById('transactionsTableBody');
            const emptyState = document.getElementById('emptyStateTemplate').content.cloneNode(true);
            const rowTemplate = document.getElementById('transactionRowTemplate').content;


            tableBody.innerHTML = '';
            // Handle different data structures
            const transactions = data.stats.recentTransactions || data.data || data;

            if (!transactions || transactions.length === 0) {
                tableBody.appendChild(emptyState);
                return;
            }

            data.transactions.forEach(transaction => {
                const row = rowTemplate.cloneNode(true);

                this.fillTransactionRow(row, transaction);
                tableBody.appendChild(row);
            });
        },

        fillTransactionRow(row, transaction) {

            // Set row ID
            const rowElement = row.querySelector('tr');
            if (rowElement) {
                rowElement.setAttribute('data-id', transaction.id);
            }

            // Transaction ID and Reference
            const transactionIdElement = row.querySelector('.transaction-id');

            if (transactionIdElement) {
                transactionIdElement.textContent = transaction.id || `TXN-${transaction.id}`;
            }


            // Date and Time
            const dateElement = row.querySelector('.transaction-date');
            const timeElement = row.querySelector('.transaction-time');

            if (dateElement) dateElement.textContent = formatDate(transaction.createdAt);
            if (timeElement) timeElement.textContent = formatTime(transaction.createdAt);

            // Description and Payment Method
            const descriptionElement = row.querySelector('.transaction-description');
            const paymentMethodTextElement = row.querySelector('.payment-method-text');

            if (descriptionElement) {
                descriptionElement.textContent = transaction.description || 'Payment for verification';
            }

            if (paymentMethodTextElement) {
                paymentMethodTextElement.textContent = transaction.paymentMethod || 'N/A';
            }

            // Verification Link
            const verificationCell = row.querySelector('.verification-cell');
            if (verificationCell) {
                if (transaction.metadata) {
                    const link = verificationCell.querySelector('.verification-link');
                    if (link) {
                        link.href = `/verifications/${transaction.metadata.verificationId}`;
                        link.textContent = `#${transaction.metadata.referenceNumber}`;
                    } else {
                        const newLink = document.createElement('a');
                        newLink.href = `/verifications/${transaction.metadata.verificationId}`;
                        newLink.className = 'text-decoration-none verification-link';
                        newLink.textContent = `#${transaction.metadata.referenceNumber}`;
                        verificationCell.innerHTML = '';
                        verificationCell.appendChild(newLink);
                    }
                } else {
                    verificationCell.innerHTML = '<span class="text-muted">-</span>';
                }
            }

            // Amount and Currency
            const amountElement = row.querySelector('.amount-value');
            const currencyElement = row.querySelector('.currency-code');

            if (amountElement) {
                const isRefund = transaction.type === 'refund' || transaction.amount < 0;
                amountElement.textContent = `${isRefund ? '-' : ''}$${Math.abs(transaction.amount)}`;
                amountElement.className = `d-block amount-value ${isRefund ? 'text-danger' : 'text-success'}`;
            }

            if (currencyElement) {
                currencyElement.textContent = transaction.currency || 'USD';
            }

            // Status Badge
            const statusBadge = row.querySelector('.status-badge');
            if (statusBadge) {
                statusBadge.className = `status-badge status-${transaction.status}`;
                statusBadge.textContent = transaction.status;
            }

            // Payment Method Icon
            const paymentIconElement = row.querySelector('.payment-method-icon');
            const paymentMethodDisplayElement = row.querySelector('.payment-method-display');

            if (paymentIconElement) {
                paymentIconElement.className = `fas payment-method-icon ${this.getPaymentMethodIcon(transaction.paymentMethod)} me-2 text-muted`;
            }

            if (paymentMethodDisplayElement) {
                paymentMethodDisplayElement.textContent = transaction.paymentMethod || 'Unknown';
            }



            // Add event listeners to buttons with data attributes
            const viewBtn = row.querySelector('.view-btn');
            if (viewBtn) {
                viewBtn.addEventListener('click', () => {
                    this.showTransactionDetails(transaction.id);
                });
            }

            // Add event listeners to all action buttons
            const viewReceiptBtn = row.querySelector('.view-receipt-btn');
            if (viewReceiptBtn) {
                viewReceiptBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    viewReceipt(transaction.id);
                });
            }

            const printInvoiceBtn = row.querySelector('.print-invoice-btn');
            if (printInvoiceBtn) {
                printInvoiceBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    printInvoice(transaction.id);
                });
            }

            const shareBtn = row.querySelector('.share-btn');
            if (shareBtn) {
                shareBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    shareTransaction(transaction.id);
                });
            }

            const markPaidBtn = row.querySelector('.mark-paid-btn');
            if (markPaidBtn && transaction.status === 'pending') {
                markPaidBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.markAsPaid(transaction.id);
                });
            }

            const refundBtn = row.querySelector('.refund-btn');
            if (refundBtn && transaction.status === 'completed') {
                refundBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.processRefund(transaction.id);
                });
            }

            const deleteBtn = row.querySelector('.delete-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.deleteTransaction(transaction.id);             
                });
            }


        },

        async deleteTransaction(transactionId) {
            try {
                if (!confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
                    return;
                }

                const token = AuthService.getToken();
                const response = await fetch(`/transactions/delete/${transactionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showToast('success', 'Verification deleted successfully!');
                        this.loadTransactions(this.currentPage);
                    } else {
                        throw new Error(data.message || 'Failed to delete verification');
                    }
                } else {
                    throw new Error('Failed to delete verification');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showToast('error', error.message || 'Failed to delete verification');
            }
        },


        async showTransactionDetails(transactionId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/transactions/api/${transactionId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const transaction = await response.json();
                    this.renderTransactionDetails(transaction.data);

                    const modal = new bootstrap.Modal(document.getElementById('transactionDetailsModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Error loading transaction details:', error);
                showToast('error', 'Failed to load transaction details');
            }
        },

        renderTransactionDetails(transaction) {
            const content = document.getElementById('transactionDetailsContent');

            const detailsHtml = `
        <div class="row">
            <div class="col-md-6">
                <div class="detail-item mb-3">
                    <label class="text-muted small">Transaction ID</label>
                    <p class="mb-0 fw-bold" id="transactionId">${transaction.id}</p>
                </div>
                <div class="detail-item mb-3">
                    <label class="text-muted small">Date & Time</label>
                    <p class="mb-0" id="transactionDate">${new Date(transaction.createdAt).toLocaleString()}</p>
                </div>
                <div class="detail-item mb-3">
                    <label class="text-muted small">Amount</label>
                    <p class="mb-0 fw-bold text-success" id="transactionAmount">$${transaction.amount} ${transaction.currency}</p>
                </div>
                <div class="detail-item mb-3">
                    <label class="text-muted small">Status</label>
                    <p id="transactionStatusWrapper">
                        <span class="status-badge status-${transaction.status}" id="transactionStatus">${transaction.status}</span>
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="detail-item mb-3">
                    <label class="text-muted small">Payment Method</label>
                    <p class="mb-0" id="transactionType">${transaction.paymentMethod}</p>
                </div>
                <div class="detail-item mb-3">
                    <label class="text-muted small">Reference Number</label>
                    ${transaction.metadata ?
                    `<p class="mb-0" id="referenceNumber">
                            <a href="/verifications/api/${transaction.metadata.verificationId}" class="text-decoration-none">
                                #${transaction.metadata.referenceNumber}
                            </a>
                        </p>` :
                    '<p class="mb-0 text-muted">N/A</p>'}
                </div>
                <div class="detail-item mb-3">
                    <label class="text-muted small">Description</label>
                    <p class="mb-0" id="transactionDescription">${transaction.description}</p>
                </div>
                <div class="detail-item mb-3">
                    <label class="text-muted small">Gateway Reference</label>
                    <p class="mb-0">${transaction.gatewayReference || 'N/A'}</p>
                </div>
            </div>
        </div>
        
        ${transaction.metadata ? `
        <div class="mt-4">
            <h6 class="mb-3">Additional Information</h6>
            <pre class="bg-light p-3 rounded" style="max-height: 200px; overflow: auto;">
                ${JSON.stringify(transaction.metadata, null, 2)}
            </pre>
        </div>
        ` : ''}
    `;

            content.innerHTML = detailsHtml;

            // Store the transaction object globally for print function
            window.currentTransaction = transaction;
        },

        updateSummary(stats) {
            // Update financial cards
            document.getElementById('totalTopups').textContent = `$${stats.totalTopups || 0}`;
            document.getElementById('totalWithdrawals').textContent = `$${stats.totalSpent || 0}`;
            document.getElementById('totalRefunds').textContent = `$${stats.currentBalance || 0}`;
            document.getElementById('totalTransactions').textContent = `${stats.totalTransactions || 0}`;

            // Update status distribution

            //document.getElementById('countCompleted').textContent = stats.statusDistribution.completed ? stats.statusDistribution.completed.count : 0;
            //document.getElementById('countPending').textContent = stats.statusDistribution.pending ? stats.statusDistribution.pending.count : 0;
            //document.getElementById('countFailed').textContent = stats.statusDistribution.failed ? stats.statusDistribution.failed.count : 0;
            //document.getElementById('countRefunded').textContent = stats.statusDistribution.refunded ? stats.statusDistribution.refunded.coount : 0;

        },

        updatePagination(total, currentPage) {
            this.totalItems = total;
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(total / this.pageSize);

            // Update showing counts
            const start = ((currentPage - 1) * this.pageSize) + 1;
            const end = Math.min(currentPage * this.pageSize, total);

            document.getElementById('startCount').textContent = start;
            document.getElementById('endCount').textContent = end;
            document.getElementById('totalItems').textContent = total;

            // Generate pagination
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">
                <i class="fas fa-chevron-left"></i>
            </a>`;
            pagination.appendChild(prevLi);

            // Page numbers
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = startPage + maxVisible - 1;

            if (endPage > totalPages) {
                endPage = totalPages;
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                pagination.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">
                <i class="fas fa-chevron-right"></i>
            </a>`;
            pagination.appendChild(nextLi);
        },

        getPaymentMethodIcon(method) {
            const icons = {
                'card': 'fa-credit-card',
                'bank': 'fa-university',
                'mobile': 'fa-mobile-alt',
                'paypal': 'fa-paypal',
                'cash': 'fa-money-bill'
            };
            return icons[method.toLowerCase()] || 'fa-money-check-alt';
        },

        async exportReport() {
            try {
                const token = AuthService.getToken();
                if (!token) {
                    AuthService.redirectToLogin();
                    return;
                }

                showToast('info', 'Generating PDF report...');

                // Build query string from current filters
                const params = new URLSearchParams({
                    ...this.currentFilters
                });

                const response = await fetch(`/reports/transactions/pdf?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    // Get filename from Content-Disposition header
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = `hakika-transactions-${new Date().toISOString().split('T')[0]}.pdf`;

                    if (contentDisposition) {
                        const matches = contentDisposition.match(/filename="(.+)"/);
                        if (matches && matches[1]) {
                            filename = matches[1];
                        }
                    }

                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(downloadUrl);

                    showToast('success', 'PDF report downloaded successfully!');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Failed to generate report');
                }
            } catch (error) {
                console.error('Export error:', error);
                showToast('error', error.message || 'Failed to export report');
            }
        },

        async loadVerificationsForDropdown() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/verification/view-all', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const verifications = await response.json();
                    const select = document.getElementById('verificationId');

                    verifications.verifications.forEach(verification => {
                        const option = document.createElement('option');
                        option.value = verification.id;
                        option.textContent = `#${verification.referenceNumber} - ${verification.firstName} ${verification.lastName}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading verifications:', error);
            }
        },

        async saveTransaction(transactionData) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/transactions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(transactionData)
                });

                if (response.ok) {
                    showToast('success', 'Transaction saved successfully!');
                    return await response.json();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to save transaction');
                }
            } catch (error) {
                console.error('Save transaction error:', error);
                throw error;
            }
        },

        printTransactionReceipt() {
            const modalContent = document.getElementById('transactionDetailsContent');

            if (!modalContent) {
                console.error('Transaction details content not found');
                return;
            }

            // Clone the content to avoid affecting the original
            const printContent = modalContent.cloneNode(true);

            // Remove any buttons or interactive elements
            printContent.querySelectorAll('button, .btn, .no-print').forEach(el => el.remove());

            // Open print window
            const printWindow = window.open('', '_blank');

            printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Transaction Receipt</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                @media print { 
                    body { margin: 0; } 
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <h2>Transaction Receipt</h2>
            <p>Generated: ${new Date().toLocaleString()}</p>
            <hr>
            ${printContent.innerHTML}
            <hr>
            <p class="text-muted small">Thank you for using Hakika Verification Services</p>
        </body>
        </html>
    `);

            printWindow.document.close();
            printWindow.focus();

            // Wait for content to load then print
            setTimeout(() => {
                printWindow.print();
                // Optional: Close window after printing
                // printWindow.close();
            }, 250);
        },

        addDateRangeParams(params) {
            const now = new Date();
            let fromDate = new Date();
            let toDate = new Date();

            switch (this.currentFilters.dateRange) {
                case 'today':
                    fromDate.setHours(0, 0, 0, 0);
                    toDate.setHours(23, 59, 59, 999);
                    break;
                case 'yesterday':
                    fromDate.setDate(fromDate.getDate() - 1);
                    fromDate.setHours(0, 0, 0, 0);
                    toDate = new Date(fromDate);
                    toDate.setHours(23, 59, 59, 999);
                    break;
                case 'week':
                    // Start of current week (Monday)
                    const day = fromDate.getDay();
                    const diff = fromDate.getDate() - day + (day === 0 ? -6 : 1);
                    fromDate = new Date(fromDate.setDate(diff));
                    fromDate.setHours(0, 0, 0, 0);
                    toDate.setHours(23, 59, 59, 999);
                    break;
                case 'month':
                    fromDate.setDate(1);
                    fromDate.setHours(0, 0, 0, 0);
                    toDate.setHours(23, 59, 59, 999);
                    break;
                case 'quarter':
                    const quarter = Math.floor((now.getMonth() + 3) / 3);
                    fromDate.setMonth((quarter - 1) * 3, 1);
                    fromDate.setHours(0, 0, 0, 0);
                    toDate = new Date(fromDate);
                    toDate.setMonth(toDate.getMonth() + 3, 0);
                    toDate.setHours(23, 59, 59, 999);
                    break;
                case 'year':
                    fromDate.setMonth(0, 1);
                    fromDate.setHours(0, 0, 0, 0);
                    toDate.setMonth(11, 31);
                    toDate.setHours(23, 59, 59, 999);
                    break;
                case 'custom':
                    if (this.currentFilters.fromDate && this.currentFilters.toDate) {
                        fromDate = new Date(this.currentFilters.fromDate);
                        toDate = new Date(this.currentFilters.toDate);
                        toDate.setHours(23, 59, 59, 999);
                    }
                    break;
            }

            params.append('fromDate', fromDate.toISOString());
            params.append('toDate', toDate.toISOString());
        },

        updateCounts(stats) {
            // Update the status distribution counts
            if (stats.statusDistribution) {
                document.getElementById('countCompleted').textContent = stats.statusDistribution.completed || 0;
                document.getElementById('countPending').textContent = stats.statusDistribution.pending || 0;
                document.getElementById('countFailed').textContent = stats.statusDistribution.failed || 0;
                document.getElementById('countRefunded').textContent = stats.statusDistribution.refunded || 0;
            }
        },

        async resetFilters() {
            this.currentFilters = {
                dateRange: 'week',
                status: 'all',
                paymentMethod: 'all',
                institution: 'all',
                search: '',
                fromDate: null,
                toDate: null
            };

            // Reset UI elements
            document.getElementById('dateRange').value = 'week';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('paymentMethodFilter').value = 'all';
            document.getElementById('institutionFilter').value = 'all';
            document.getElementById('tableSearch').value = '';
            document.getElementById('customDateRange').classList.add('d-none');

            await this.loadTransactions(1);
        },

        async searchTransactions(searchTerm) {
            this.currentFilters.search = searchTerm.trim();
            await this.applyFilters();
        },

        applyFilters() {
            this.currentPage = 1;
            this.loadTransactions(1);
        },

        async reconcileTransactions() {
            try {
                const token = AuthService.getToken();
                if (!token) {
                    AuthService.redirectToLogin();
                    return;
                }

                // Show confirmation dialog
                if (!confirm('Are you sure you want to reconcile all pending transactions? This will check their status with payment processors.')) {
                    return;
                }

                showToast('info', 'Starting transaction reconciliation...', true);

                const response = await fetch('/transactions/reconcile', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        dateRange: this.currentFilters.dateRange,
                        fromDate: this.currentFilters.fromDate,
                        toDate: this.currentFilters.toDate
                    })
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success) {
                        showToast('success', `Reconciliation completed: ${result.data.updated} transactions updated, ${result.data.failed} failed`);

                        // Show reconciliation report
                        this.showReconciliationReport(result.data);

                        // Refresh transactions
                        this.loadTransactions(this.currentPage);
                    } else {
                        throw new Error(result.message || 'Reconciliation failed');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Reconciliation error:', error);
                showToast('error', error.message || 'Failed to reconcile transactions');
            }
        },

        async processRefund(transactionId = null) {
            try {
                const token = AuthService.getToken();
                if (!token) {
                    AuthService.redirectToLogin();
                    return;
                }

                // If transactionId is provided, process refund for that specific transaction
                if (transactionId) {
                    return await this.processSingleRefund(transactionId);
                }

                // Otherwise show the bulk refund modal
                this.showRefundModal();

            } catch (error) {
                console.error('Refund error:', error);
                showToast('error', 'Failed to process refund');
            }
        },

        async processSingleRefund(transactionId) {
            try {
                // First, get transaction details
                const transaction = await this.fetchTransactionDetails(transactionId);

                if (!transaction) {
                    showToast('error', 'Transaction not found');
                    return;
                }

                // Check if transaction is refundable
                if (!this.isTransactionRefundable(transaction)) {
                    showToast('warning', 'This transaction cannot be refunded');
                    return;
                }

                // Show refund confirmation modal
                this.showRefundConfirmation(transaction);

            } catch (error) {
                console.error('Single refund error:', error);
                throw error;
            }
        },

        showRefundModal() {
            // Create or get refund modal
            let refundModal = document.getElementById('refundModal');
            if (!refundModal) {
                refundModal = this.createRefundModal();
                document.body.appendChild(refundModal);
            }

            // Show the modal
            const modal = new bootstrap.Modal(refundModal);
            modal.show();

            // Load pending refunds
            this.loadPendingRefunds();
        },

        createRefundModal() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'refundModal';
            modal.tabIndex = -1;
            modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-undo me-2"></i>Process Refunds
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Select transactions to process refunds. Only completed transactions can be refunded.
                        </div>
                        
                        <!-- Refund Filters -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label small">Refund Type</label>
                                <select class="form-select" id="refundType">
                                    <option value="full">Full Refund</option>
                                    <option value="partial">Partial Refund</option>
                                    <option value="percentage">Percentage Refund</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">Refund Reason</label>
                                <select class="form-select" id="refundReason">
                                    <option value="">Select reason...</option>
                                    <option value="duplicate">Duplicate Payment</option>
                                    <option value="cancelled">Service Cancelled</option>
                                    <option value="failed">Service Failed</option>
                                    <option value="customer_request">Customer Request</option>
                                    <option value="error">Processing Error</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Partial Refund Amount (hidden by default) -->
                        <div class="row mb-4 d-none" id="partialRefundAmount">
                            <div class="col-md-6">
                                <label class="form-label small">Refund Amount ($)</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="refundAmount" step="0.01" min="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">Percentage (%)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="refundPercentage" min="1" max="100">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Transactions Table -->
                        <div class="table-responsive">
                            <table class="table table-sm" id="refundTransactionsTable">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAllRefunds">
                                        </th>
                                        <th>Transaction ID</th>
                                        <th>Amount</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Refundable</th>
                                    </tr>
                                </thead>
                                <tbody id="refundTransactionsBody">
                                    <!-- Transactions will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Refund Summary -->
                        <div class="card mt-4">
                            <div class="card-body">
                                <h6 class="mb-3">Refund Summary</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1">
                                            <span class="text-muted">Selected Transactions:</span>
                                            <strong id="selectedCount">0</strong>
                                        </p>
                                        <p class="mb-1">
                                            <span class="text-muted">Total Amount:</span>
                                            <strong id="totalRefundAmount">$0.00</strong>
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1">
                                            <span class="text-muted">Refund Amount:</span>
                                            <strong id="calculatedRefund">$0.00</strong>
                                        </p>
                                        <p class="mb-0">
                                            <span class="text-muted">Service Fee:</span>
                                            <strong id="serviceFee">$0.00</strong>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Refund Notes -->
                        <div class="mt-3">
                            <label class="form-label small">Refund Notes</label>
                            <textarea class="form-control" id="refundNotes" rows="3" 
                                      placeholder="Add any notes about this refund..."></textarea>
                            <div class="form-text">This will be included in the refund record</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-warning" id="processRefundsBtn" disabled>
                            <i class="fas fa-undo me-2"></i>Process Refunds
                        </button>
                    </div>
                </div>
            </div>
        `;

            // Add event listeners
            modal.addEventListener('shown.bs.modal', () => {
                this.initializeRefundModalEvents();
            });

            return modal;
        },

        async loadPendingRefunds() {
            try {
                const token = AuthService.getToken();
                const response = await fetch('/transactions/refundable', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const transactions = await response.json();
                    this.renderRefundableTransactions(transactions);
                } else {
                    showToast('error', transactions.message);
                }
            } catch (error) {
                console.error('Error loading refundable transactions:', error);
                showToast('error', 'Failed to load refundable transactions');
            }
        },

        renderRefundableTransactions(transactions) {
            const tbody = document.getElementById('refundTransactionsBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (transactions.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <i class="fas fa-check-circle text-success fa-2x mb-2"></i>
                        <p class="text-muted mb-0">No refundable transactions found</p>
                    </td>
                </tr>
            `;
                return;
            }

            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                const isRefundable = this.isTransactionRefundable(transaction);

                row.innerHTML = `
                <td>
                    <input type="checkbox" class="refund-checkbox" 
                           data-id="${transaction.id}" 
                           data-amount="${transaction.amount}"
                           ${!isRefundable ? 'disabled' : ''}>
                </td>
                <td>
                    <small class="text-muted d-block">${transaction.id}</small>
                    <small>${transaction.description || 'No description'}</small>
                </td>
                <td>
                    <span class="fw-bold ${transaction.amount < 0 ? 'text-danger' : 'text-success'}">
                        $${Math.abs(transaction.amount).toFixed(2)}
                    </span>
                </td>
                <td>${formatDate(transaction.createdAt)}</td>
                <td>
                    <span class="badge bg-${this.getStatusColor(transaction.status)}">
                        ${transaction.status}
                    </span>
                </td>
                <td>
                    ${isRefundable ?
                        '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Refundable</span>' :
                        '<span class="badge bg-secondary"><i class="fas fa-times me-1"></i>Not Refundable</span>'}
                </td>
            `;

                tbody.appendChild(row);
            });

            this.updateRefundSummary();
        },

        initializeRefundModalEvents() {
            // Refund type change
            const refundType = document.getElementById('refundType');
            const partialRefundDiv = document.getElementById('partialRefundAmount');

            refundType.addEventListener('change', (e) => {
                if (e.target.value === 'full') {
                    partialRefundDiv.classList.add('d-none');
                } else {
                    partialRefundDiv.classList.remove('d-none');
                }
                this.updateRefundSummary();
            });

            // Amount/percentage input changes
            document.getElementById('refundAmount')?.addEventListener('input', () => this.updateRefundSummary());
            document.getElementById('refundPercentage')?.addEventListener('input', () => this.updateRefundSummary());

            // Select all checkbox
            document.getElementById('selectAllRefunds')?.addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('.refund-checkbox:not(:disabled)');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
                this.updateRefundSummary();
            });

            // Individual checkbox changes
            document.addEventListener('change', (e) => {
                if (e.target.classList.contains('refund-checkbox')) {
                    this.updateRefundSummary();
                }
            });

            // Process refunds button
            document.getElementById('processRefundsBtn')?.addEventListener('click', () => {
                this.processBulkRefunds();
            });
        },

        updateRefundSummary() {
            const checkboxes = document.querySelectorAll('.refund-checkbox:checked:not(:disabled)');
            const selectedCount = checkboxes.length;

            // Calculate total amount
            let totalAmount = 0;
            checkboxes.forEach(checkbox => {
                const amount = parseFloat(checkbox.getAttribute('data-amount')) || 0;
                totalAmount += Math.abs(amount);
            });

            // Calculate refund amount based on type
            const refundType = document.getElementById('refundType')?.value || 'full';
            let refundAmount = totalAmount;
            let serviceFee = 0;

            if (refundType === 'partial') {
                const partialAmount = parseFloat(document.getElementById('refundAmount')?.value) || 0;
                refundAmount = Math.min(partialAmount, totalAmount);
            } else if (refundType === 'percentage') {
                const percentage = parseFloat(document.getElementById('refundPercentage')?.value) || 0;
                const actualPercentage = Math.min(percentage, 100);
                refundAmount = totalAmount * (actualPercentage / 100);
            }

            // Calculate service fee (2.9% + $0.30 for card payments)
            serviceFee = refundAmount * 0.029 + 0.30;
            const netRefund = refundAmount - serviceFee;

            // Update UI
            document.getElementById('selectedCount').textContent = selectedCount;
            document.getElementById('totalRefundAmount').textContent = `$${totalAmount.toFixed(2)}`;
            document.getElementById('calculatedRefund').textContent = `$${refundAmount.toFixed(2)}`;
            document.getElementById('serviceFee').textContent = `$${serviceFee.toFixed(2)}`;

            // Enable/disable process button
            const processBtn = document.getElementById('processRefundsBtn');
            if (processBtn) {
                processBtn.disabled = selectedCount === 0 || refundAmount <= 0;
            }
        },

        async processBulkRefunds() {
            try {
                const token = AuthService.getToken();
                if (!token) {
                    AuthService.redirectToLogin();
                    return;
                }

                // Get selected transactions
                const checkboxes = document.querySelectorAll('.refund-checkbox:checked:not(:disabled)');
                if (checkboxes.length === 0) {
                    showToast('warning', 'Please select at least one transaction to refund');
                    return;
                }

                // Get refund details
                const refundType = document.getElementById('refundType')?.value || 'full';
                const refundReason = document.getElementById('refundReason')?.value;
                const refundNotes = document.getElementById('refundNotes')?.value;
                let refundAmount = null;
                let refundPercentage = null;

                if (refundType === 'partial') {
                    refundAmount = parseFloat(document.getElementById('refundAmount')?.value) || 0;
                } else if (refundType === 'percentage') {
                    refundPercentage = parseFloat(document.getElementById('refundPercentage')?.value) || 0;
                }

                if (!refundReason) {
                    showToast('warning', 'Please select a refund reason');
                    return;
                }

                // Confirm refund
                if (!confirm(`Are you sure you want to process refunds for ${checkboxes.length} transaction(s)? This action cannot be undone.`)) {
                    return;
                }

                // Prepare refund data
                const transactionIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));
                const refundData = {
                    transactionIds,
                    refundType,
                    refundReason,
                    refundNotes,
                    refundAmount,
                    refundPercentage
                };

                showToast('info', 'Processing refunds...', true);

                const response = await fetch('/api/transactions/refund/bulk', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(refundData)
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success) {
                        showToast('success', `Successfully processed ${result.data.successful} refund(s). ${result.data.failed} failed.`);

                        // Close modal
                        bootstrap.Modal.getInstance(document.getElementById('refundModal')).hide();

                        // Refresh transactions
                        this.loadTransactions(this.currentPage);

                        // Show refund report
                        this.showRefundReport(result.data);
                    } else {
                        throw new Error(result.message || 'Refund processing failed');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Bulk refund error:', error);
                showToast('error', error.message || 'Failed to process refunds');
            }
        },

        showRefundConfirmation(transaction) {
            // Create confirmation modal
            const modalHtml = `
            <div class="modal fade" id="singleRefundModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-undo me-2 text-warning"></i>Confirm Refund
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                You are about to refund this transaction. This action cannot be undone.
                            </div>
                            
                            <div class="transaction-details p-3 bg-light rounded mb-3">
                                <p class="mb-2">
                                    <strong>Transaction ID:</strong> ${transaction.id}
                                </p>
                                <p class="mb-2">
                                    <strong>Amount:</strong> 
                                    <span class="fw-bold text-danger">$${Math.abs(transaction.amount).toFixed(2)}</span>
                                </p>
                                <p class="mb-2">
                                    <strong>Date:</strong> ${formatDate(transaction.createdAt)}
                                </p>
                                <p class="mb-0">
                                    <strong>Description:</strong> ${transaction.description}
                                </p>
                            </div>
                            
                            <form id="singleRefundForm">
                                <div class="mb-3">
                                    <label class="form-label">Refund Reason</label>
                                    <select class="form-select" name="reason" required>
                                        <option value="">Select reason...</option>
                                        <option value="duplicate">Duplicate Payment</option>
                                        <option value="cancelled">Service Cancelled</option>
                                        <option value="failed">Service Failed</option>
                                        <option value="customer_request">Customer Request</option>
                                        <option value="error">Processing Error</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Refund Type</label>
                                    <select class="form-select" name="type" id="singleRefundType">
                                        <option value="full">Full Refund ($${Math.abs(transaction.amount).toFixed(2)})</option>
                                        <option value="partial">Partial Refund</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3 d-none" id="singlePartialAmount">
                                    <label class="form-label">Refund Amount</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" name="amount" 
                                               step="0.01" min="0.01" max="${Math.abs(transaction.amount)}"
                                               placeholder="Enter refund amount">
                                    </div>
                                    <div class="form-text">Maximum: $${Math.abs(transaction.amount).toFixed(2)}</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Notes (Optional)</label>
                                    <textarea class="form-control" name="notes" rows="2" 
                                              placeholder="Add any notes about this refund..."></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-warning" id="confirmSingleRefundBtn">
                                <i class="fas fa-undo me-2"></i>Process Refund
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

            // Remove existing modal if any
            const existingModal = document.getElementById('singleRefundModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Initialize modal
            const modal = new bootstrap.Modal(document.getElementById('singleRefundModal'));
            modal.show();

            // Add event listeners
            const refundTypeSelect = document.getElementById('singleRefundType');
            const partialAmountDiv = document.getElementById('singlePartialAmount');

            refundTypeSelect.addEventListener('change', (e) => {
                if (e.target.value === 'partial') {
                    partialAmountDiv.classList.remove('d-none');
                } else {
                    partialAmountDiv.classList.add('d-none');
                }
            });

            document.getElementById('confirmSingleRefundBtn').addEventListener('click', async () => {
                await this.confirmSingleRefund(transaction.id);
            });
        },

        async confirmSingleRefund(transactionId) {
            try {
                const form = document.getElementById('singleRefundForm');
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }

                const formData = new FormData(form);
                const refundData = {
                    reason: formData.get('reason'),
                    type: formData.get('type'),
                    notes: formData.get('notes')
                };

                if (refundData.type === 'partial') {
                    const amount = parseFloat(formData.get('amount'));
                    if (isNaN(amount) || amount <= 0) {
                        showToast('warning', 'Please enter a valid refund amount');
                        return;
                    }
                    refundData.amount = amount;
                }

                const token = AuthService.getToken();
                const response = await fetch(`/api/transactions/${transactionId}/refund`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(refundData)
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success) {
                        showToast('success', 'Refund processed successfully');

                        // Close modal
                        bootstrap.Modal.getInstance(document.getElementById('singleRefundModal')).hide();

                        // Refresh transactions
                        this.loadTransactions(this.currentPage);
                    } else {
                        throw new Error(result.message || 'Refund failed');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Single refund error:', error);
                showToast('error', error.message || 'Failed to process refund');
            }
        },

        showReconciliationReport(data) {
            const modalHtml = `
            <div class="modal fade" id="reconciliationReportModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-sync-alt me-2"></i>Reconciliation Report
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                Reconciliation completed successfully!
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h1 class="text-success">${data.updated || 0}</h1>
                                            <p class="mb-0">Transactions Updated</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h1 class="text-warning">${data.failed || 0}</h1>
                                            <p class="mb-0">Failed Updates</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h1 class="text-info">${data.total || 0}</h1>
                                            <p class="mb-0">Total Processed</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${data.failedTransactions && data.failedTransactions.length > 0 ? `
                            <div class="mb-4">
                                <h6>Failed Transactions</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Transaction ID</th>
                                                <th>Error</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.failedTransactions.map(tx => `
                                                <tr>
                                                    <td><small>${tx.id}</small></td>
                                                    <td><small class="text-danger">${tx.error}</small></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${data.updatedDetails ? `
                            <div>
                                <h6>Update Details</h6>
                                <ul class="list-group">
                                    ${Object.entries(data.updatedDetails).map(([status, count]) => `
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            ${status.replace('_', ' ').toUpperCase()}
                                            <span class="badge bg-primary rounded-pill">${count}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-outline-primary" onclick="TransactionsService.exportReconciliationReport()">
                                <i class="fas fa-download me-2"></i>Export Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

            // Remove existing modal if any
            const existingModal = document.getElementById('reconciliationReportModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('reconciliationReportModal'));
            modal.show();
        },

        showRefundReport(data) {
            const modalHtml = `
            <div class="modal fade" id="refundReportModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-undo me-2 text-warning"></i>Refund Report
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                Refund processing completed!
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h1 class="text-success">${data.successful || 0}</h1>
                                            <p class="mb-0">Successful</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h1 class="text-danger">${data.failed || 0}</h1>
                                            <p class="mb-0">Failed</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h1 class="text-warning">$${(data.totalRefunded || 0).toFixed(2)}</h1>
                                            <p class="mb-0">Total Refunded</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h1 class="text-info">$${(data.serviceFees || 0).toFixed(2)}</h1>
                                            <p class="mb-0">Service Fees</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${data.refundedTransactions && data.refundedTransactions.length > 0 ? `
                            <div class="mb-4">
                                <h6>Refunded Transactions</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Transaction ID</th>
                                                <th>Original Amount</th>
                                                <th>Refund Amount</th>
                                                <th>New Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.refundedTransactions.map(tx => `
                                                <tr>
                                                    <td><small>${tx.id}</small></td>
                                                    <td>
                                                        <span class="text-danger">$${Math.abs(tx.originalAmount).toFixed(2)}</span>
                                                    </td>
                                                    <td>
                                                        <span class="text-success">$${tx.refundAmount.toFixed(2)}</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-warning">${tx.newStatus}</span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${data.failedTransactions && data.failedTransactions.length > 0 ? `
                            <div>
                                <h6 class="text-danger">Failed Refunds</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Transaction ID</th>
                                                <th>Error</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.failedTransactions.map(tx => `
                                                <tr>
                                                    <td><small>${tx.id}</small></td>
                                                    <td><small class="text-danger">${tx.error}</small></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-outline-primary" onclick="TransactionsService.exportRefundReport()">
                                <i class="fas fa-download me-2"></i>Export Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

            // Remove existing modal if any
            const existingModal = document.getElementById('refundReportModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('refundReportModal'));
            modal.show();
        },

        async exportReconciliationReport() {
            try {
                showToast('info', 'Generating reconciliation report...');

                // You can implement PDF generation here
                // For now, just show a message
                showToast('success', 'Report export feature coming soon!');
            } catch (error) {
                console.error('Export error:', error);
                showToast('error', 'Failed to export report');
            }
        },

        async exportRefundReport() {
            try {
                showToast('info', 'Generating refund report...');

                // You can implement PDF generation here
                // For now, just show a message
                showToast('success', 'Report export feature coming soon!');
            } catch (error) {
                console.error('Export error:', error);
                showToast('error', 'Failed to export report');
            }
        },

        isTransactionRefundable(transaction) {
            // Check if transaction is refundable
            const { status, createdAt, amount } = transaction;

            // Must be completed
            if (status !== 'completed') {
                return false;
            }

            // Must be positive amount (debits can't be refunded)
            if (amount <= 0) {
                return false;
            }

            // Check if within refund window (30 days)
            const transactionDate = new Date(createdAt);
            const currentDate = new Date();
            const daysDiff = Math.floor((currentDate - transactionDate) / (1000 * 60 * 60 * 24));

            if (daysDiff > 30) {
                return false;
            }

            return true;
        },

    };

    document.addEventListener('DOMContentLoaded', function () {
        // Load initial data
        TransactionsService.loadTransactions();

        // Initialize print button when modal is shown
        const printReceiptBtn = document.getElementById('printReceiptBtn');
        const transactionDetailsModal = document.getElementById('transactionDetailsModal');

        if (printReceiptBtn) {
            printReceiptBtn.addEventListener('click', function () {
                printTransactionReceipt();
            });
        }

        // Date Range Filter
        const dateRangeSelect = document.getElementById('dateRange');
        if (dateRangeSelect) {
            dateRangeSelect.addEventListener('change', function (e) {
                if (e.target.value === 'custom') {
                    document.getElementById('customDateRange').classList.remove('d-none');
                } else {
                    document.getElementById('customDateRange').classList.add('d-none');
                    TransactionsService.currentFilters.dateRange = e.target.value;
                    TransactionsService.applyFilters();
                }
            });
        }

        // Apply custom date range
        const applyDateRangeBtn = document.getElementById('applyDateRange');
        applyDateRangeBtn.addEventListener('click', function () {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;

            if (!fromDate || !toDate) {
                showToast('warning', 'Please select both from and to dates');
                return;
            }

            if (new Date(fromDate) > new Date(toDate)) {
                showToast('warning', 'From date cannot be after to date');
                return;
            }

            TransactionsService.currentFilters.fromDate = fromDate;
            TransactionsService.currentFilters.toDate = toDate;
            TransactionsService.currentFilters.dateRange = 'custom';
            TransactionsService.applyFilters();
        });

        // Status Filter
        const statusFilter = document.getElementById('statusFilter');
        if (statusFilter) {
            statusFilter.addEventListener('change', function (e) {
                TransactionsService.currentFilters.status = e.target.value;
                TransactionsService.applyFilters();
            });
        }

        // Payment Method Filter
        const paymentMethodFilter = document.getElementById('paymentMethodFilter');
        if (paymentMethodFilter) {
            paymentMethodFilter.addEventListener('change', function (e) {
                TransactionsService.currentFilters.paymentMethod = e.target.value;
                TransactionsService.applyFilters();
            });
        }

        // Institution Filter
        // const institutionFilter = document.getElementById('institutionFilter');
        //if (institutionFilter) {
        // Populate institution dropdown if needed
        //  institutionFilter.addEventListener('change', function (e) {
        //    TransactionsService.currentFilters.institution = e.target.value;
        //  TransactionsService.applyFilters();
        //});
        //}

        // Table Search
        const tableSearch = document.getElementById('tableSearch');
        let searchTimeout;

        if (tableSearch) {
            tableSearch.addEventListener('input', function (e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    TransactionsService.searchTransactions(e.target.value);
                }, 500);
            });

            // Also allow pressing Enter to search immediately
            tableSearch.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    TransactionsService.searchTransactions(e.target.value);
                }
            });
        }

        // Reset Filters Button (add this to your HTML if not present)
        const resetFiltersBtn = document.getElementById('resetFiltersBtn');
        if (!resetFiltersBtn) {
            // Create and add reset button if not in HTML
            const filterCard = document.querySelector('.card.shadow-sm.mb-4 .card-body');
            if (filterCard) {
                const resetBtn = document.createElement('button');
                resetBtn.id = 'resetFiltersBtn';
                resetBtn.className = 'btn btn-outline-secondary btn-sm mt-3';
                resetBtn.innerHTML = '<i class="fas fa-redo me-1"></i>Reset Filters';
                filterCard.appendChild(resetBtn);

                resetBtn.addEventListener('click', function () {
                    TransactionsService.resetFilters();
                });
            }
        } else {
            resetFiltersBtn.addEventListener('click', function () {
                TransactionsService.resetFilters();
            });
        }

        // Export Report
        const exportReportBtn = document.getElementById('exportReportBtn');
        if (exportReportBtn) {
            exportReportBtn.addEventListener('click', function () {
                TransactionsService.exportReport();
            });
        }

        // Pagination
        document.getElementById('pagination').addEventListener('click', function (e) {
            e.preventDefault();
            if (e.target.tagName === 'A') {
                const page = parseInt(e.target.getAttribute('data-page'));
                if (page && !isNaN(page)) {
                    TransactionsService.loadTransactions(page);
                }
            }
        });

        // Quick Actions
        // document.getElementById('reconcileBtn').addEventListener('click', function () {
        //   showToast('info', 'Starting transaction reconciliation...');
        // TransactionsService.reconcileTransactions();
        //});

        // document.getElementById('generateInvoiceBtn').addEventListener('click', function () {
        //     showToast('info', 'Generating invoice...');
        // });

        document.getElementById('refundBtn').addEventListener('click', function () {
            showToast('info', 'Opening refund form...');
            TransactionsService.processRefund();
        });

        //document.getElementById('reportsBtn').addEventListener('click', function () {
        //    window.location.href = '/reports/transactions';
        //});

        // New Transaction Button
        //document.getElementById('newTransactionBtn').addEventListener('click', function () {
        //  const modal = new bootstrap.Modal(document.getElementById('addTransactionModal'));
        //    modal.show();

        // Load verifications for dropdown
        //  TransactionsService.loadVerificationsForDropdown();

        // Set default date to current date/time
        //  const now = new Date();
        //const formattedDate = now.toISOString().slice(0, 16);
        //document.getElementById('transactionDate').value = formattedDate;

        // Generate reference number if empty
        //if (!document.getElementById('referenceNumber').value) {
        //  const refNumber = `TXN-${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
        //document.getElementById('referenceNumber').value = refNumber;
        //}
        //});

        document.getElementById('saveTransactionBtn').addEventListener('click', async function () {
            const form = document.getElementById('addTransactionForm');
            const saveBtn = this;

            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            const formData = new FormData(form);
            const transactionData = {};

            // Convert FormData to object
            for (const [key, value] of formData.entries()) {
                if (value) {
                    transactionData[key] = value;
                }
            }

            // Handle metadata
            const metadata = {};
            if (formData.get('gatewayReference')) metadata.gatewayReference = formData.get('gatewayReference');
            if (formData.get('payerEmail')) metadata.payerEmail = formData.get('payerEmail');
            if (formData.get('payerName')) metadata.payerName = formData.get('payerName');
            if (formData.get('payerPhone')) metadata.payerPhone = formData.get('payerPhone');
            if (formData.get('notes')) metadata.notes = formData.get('notes');

            if (Object.keys(metadata).length > 0) {
                transactionData.metadata = metadata;
            }

            // Add transactionId if reference number provided
            if (transactionData.referenceNumber) {
                transactionData.transactionId = transactionData.referenceNumber;
            }

            // Convert amount to number
            transactionData.amount = parseFloat(transactionData.amount);

            try {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';

                await TransactionsService.saveTransaction(transactionData);

                // Close modal and refresh table
                bootstrap.Modal.getInstance(document.getElementById('addTransactionModal')).hide();
                TransactionsService.loadTransactions(TransactionsService.currentPage);

                // Reset form
                form.reset();
                form.classList.remove('was-validated');

            } catch (error) {
                showToast('error', error.message || 'Failed to save transaction');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Transaction';
            }
        });

        // Also make the entire row clickable for viewing details


    });

    async function viewReceipt(transactionId) {
        try {
            // Fetch transaction details
            const transaction = await fetchTransactionDetails(transactionId);

            if (!transaction) {
                showToast('error', 'Transaction not found');
                return;
            }

            // Render receipt in a modal
            renderReceiptModal(transaction);

            // Show the modal
            const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal') || createReceiptModal());
            receiptModal.show();

        } catch (error) {
            console.error('Error viewing receipt:', error);
            showToast('error', 'Failed to load receipt');
        }
    }

    function renderReceiptModal(transaction) {
        // Create or get receipt modal
        let receiptModal = document.getElementById('receiptModal');
        if (!receiptModal) {
            receiptModal = createReceiptModal();
            document.body.appendChild(receiptModal);
        }

        // Format date
        const transactionDate = new Date(transaction.createdAt);
        const formattedDate = transactionDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });

        // Determine amount class
        const amountClass = transaction.amount >= 0 ? 'text-success' : 'text-danger';
        const amountSign = transaction.amount >= 0 ? '+' : '';

        // Render receipt content
        const modalContent = document.getElementById('receiptContent') ||
            receiptModal.querySelector('.modal-body');

        modalContent.innerHTML = `
        <div class="receipt-container p-4">
            <!-- Receipt Header -->
            <div class="text-center mb-4">
                <div class="receipt-logo mb-3">
                    <i class="fas fa-receipt fa-3x text-primary"></i>
                </div>
                <h4 class="fw-bold">Transaction Receipt</h4>
                <p class="text-muted">${formattedDate}</p>
                <div class="receipt-number mb-3">
                    <span class="badge bg-light text-dark">Receipt #: RCPT-${transaction.id.slice(-8).toUpperCase()}</span>
                </div>
            </div>
            
            <!-- Transaction Details -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="detail-item mb-2">
                        <small class="text-muted">Transaction ID</small>
                        <p class="mb-1 fw-bold">${transaction.id}</p>
                    </div>
                    <div class="detail-item mb-2">
                        <small class="text-muted">Date & Time</small>
                        <p class="mb-1">${formattedDate}</p>
                    </div>
                    <div class="detail-item mb-2">
                        <small class="text-muted">Status</small>
                        <p class="mb-1">
                            <span class="badge bg-${getStatusColor(transaction.status)}">
                                ${transaction.status}
                            </span>
                        </p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="detail-item mb-2">
                        <small class="text-muted">Payment Method</small>
                        <p class="mb-1">${transaction.paymentMethod || 'N/A'}</p>
                    </div>
                    <div class="detail-item mb-2">
                        <small class="text-muted">Reference</small>
                        <p class="mb-1">${transaction.metadata?.referenceNumber || 'N/A'}</p>
                    </div>
                    <div class="detail-item mb-2">
                        <small class="text-muted">Gateway Reference</small>
                        <p class="mb-1">${transaction.gatewayReference || 'N/A'}</p>
                    </div>
                </div>
            </div>
            
            <!-- Amount Section -->
            <div class="amount-section text-center py-4 mb-4 bg-light rounded">
                <small class="text-muted d-block mb-1">Amount</small>
                <h2 class="${amountClass} fw-bold">
                    ${amountSign}$${transaction.amount} ${transaction.currency}
                </h2>
                <p class="mb-0">${transaction.description}</p>
            </div>
            
            <!-- Customer Info -->
            <div class="customer-info mb-4">
                <h6 class="border-bottom pb-2">Customer Information</h6>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Name:</strong> Fuseni Saeed</p>
                        <p class="mb-1"><strong>Account:</strong> Premium User</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Service:</strong> Hakika Verification</p>
                        <p class="mb-1"><strong>Platform:</strong> Web Application</p>
                    </div>
                </div>
            </div>
            
            <!-- Terms & Conditions -->
            <div class="terms-section small text-muted border-top pt-3">
                <p class="mb-1">
                    <i class="fas fa-info-circle me-1"></i>
                    This receipt serves as proof of transaction. Please keep it for your records.
                </p>
                <p class="mb-0">
                    <i class="fas fa-shield-alt me-1"></i>
                    All transactions are secured and encrypted.
                </p>
            </div>
        </div>
    `;

        // Update print button
        const printBtn = receiptModal.querySelector('#printReceiptBtn');
        if (printBtn) {
            printBtn.onclick = function () {
                printReceiptContent(modalContent.innerHTML, transaction);
            };
        }
    }

    function getStatusColor(status) {
        const statusMap = {
            'completed': 'success',
            'success': 'success',
            'paid': 'success',
            'pending': 'warning',
            'processing': 'info',
            'failed': 'danger',
            'cancelled': 'secondary'
        };
        return statusMap[status.toLowerCase()] || 'secondary';
    }

    function printTransactionReceipt() {
        // Get the modal content
        const modalContent = document.getElementById('transactionDetailsContent');

        if (!modalContent) {
            console.error('Transaction details content not found');
            showToast('error', 'Cannot print receipt: Content not found');
            return;
        }

        // Create a print-friendly version
        const printContent = createPrintableReceipt(modalContent.innerHTML);

        // Open print window
        const printWindow = window.open('', '_blank', 'width=800,height=600');

        printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Transaction Receipt - Hakika</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
            <style>
                @media print {
                    body { margin: 0; padding: 20px; }
                    .no-print { display: none !important; }
                    .receipt-container { max-width: 100% !important; }
                    .print-only { display: block !important; }
                    .btn { display: none !important; }
                    .modal-footer { display: none !important; }
                    .page-break { page-break-before: always; }
                }
                @page {
                    margin: 0.5cm;
                    size: auto;
                }
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
                    background: white !important;
                    color: black !important;
                }
                .receipt-header {
                    text-align: center;
                    margin-bottom: 30px;
                    padding-bottom: 20px;
                    border-bottom: 2px solid #ddd;
                }
                .receipt-title {
                    font-size: 24px;
                    font-weight: bold;
                    color: #2c3e50;
                    margin-bottom: 10px;
                }
                .receipt-logo {
                    max-width: 150px;
                    margin-bottom: 15px;
                }
                .receipt-info {
                    margin: 25px 0;
                }
                .receipt-section {
                    margin: 20px 0;
                    padding: 15px;
                    border: 1px solid #eee;
                    border-radius: 5px;
                }
                .receipt-label {
                    font-weight: 600;
                    color: #555;
                    min-width: 150px;
                }
                .receipt-value {
                    font-weight: 500;
                    color: #2c3e50;
                }
                .receipt-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                }
                .receipt-table th {
                    background-color: #f8f9fa;
                    padding: 10px;
                    text-align: left;
                    border-bottom: 2px solid #dee2e6;
                }
                .receipt-table td {
                    padding: 10px;
                    border-bottom: 1px solid #dee2e6;
                }
                .receipt-footer {
                    margin-top: 40px;
                    padding-top: 20px;
                    border-top: 2px solid #ddd;
                    text-align: center;
                    color: #666;
                }
                .amount-positive {
                    color: #28a745;
                    font-weight: bold;
                }
                .amount-negative {
                    color: #dc3545;
                    font-weight: bold;
                }
                .status-badge {
                    display: inline-block;
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: 600;
                }
                .status-success { background-color: #d4edda; color: #155724; }
                .status-pending { background-color: #fff3cd; color: #856404; }
                .status-failed { background-color: #f8d7da; color: #721c24; }
                
                /* Hide modal-specific elements in print */
                .modal-content, .modal-header, .modal-body, .modal-footer,
                .btn-close, .btn-secondary, .btn-primary {
                    all: unset;
                }
                
                /* Print button styling */
                .print-actions {
                    display: none;
                }
                
                /* Ensure all content is visible */
                .collapse, .collapsing {
                    display: block !important;
                    height: auto !important;
                }
            </style>
        </head>
        <body>
            <div class="container receipt-container">
                ${printContent}
            </div>
            
            <div class="receipt-footer mt-5">
                <p>Thank you for using Hakika Verification Services</p>
                <p>For any inquiries, contact: support@hakika.com | +233 (23) 536-4134</p>
                <p class="text-muted small">
                    Receipt generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}
                </p>
            </div>
            
            <script>
                // Auto-print when the window loads
                window.onload = function() {
                    window.print();
                    
                    // Close window after printing (optional)
                    setTimeout(function() {
                        window.close();
                    }, 1000);
                };
                
                // Listen for after print event
                window.onafterprint = function(event) {
                    // Optionally close the window after printing
                    setTimeout(function() {
                        window.close();
                    }, 500);
                };
            <\/script>
        </body>
        </html>
    `);

        printWindow.document.close();
    }

    async function printInvoice(transactionId) {
        try {
            // Fetch transaction details
            const transaction = await fetchTransactionDetails(transactionId);

            if (!transaction) {
                showToast('error', 'Transaction not found');
                return;
            }

            // Generate invoice and print
            printTransactionInvoice(transaction);

        } catch (error) {
            console.error('Error printing invoice:', error);
            showToast('error', 'Failed to generate invoice');
        }
    }

    function printTransactionInvoice(transaction) {
        // Create invoice HTML
        const invoiceHtml = generateInvoiceHTML(transaction);

        // Open print window
        const printWindow = window.open('', '_blank', 'width=800,height=600');

        printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Invoice - ${transaction.id}</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
            <style>
                @media print {
                    body { margin: 0; padding: 20px; }
                    .no-print { display: none !important; }
                    .invoice-container { max-width: 100% !important; }
                    .page-break { page-break-before: always; }
                    .footer { position: fixed; bottom: 0; width: 100%; }
                }
                @page {
                    margin: 1cm;
                    size: A4;
                }
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    background: white !important;
                    color: #333 !important;
                }
                .invoice-header {
                    border-bottom: 2px solid #007bff;
                    padding-bottom: 20px;
                    margin-bottom: 30px;
                }
                .invoice-title {
                    color: #2c3e50;
                    font-weight: 700;
                }
                .company-info {
                    text-align: right;
                }
                .invoice-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                }
                .invoice-table th {
                    background-color: #f8f9fa;
                    padding: 12px;
                    text-align: left;
                    border-bottom: 2px solid #dee2e6;
                }
                .invoice-table td {
                    padding: 12px;
                    border-bottom: 1px solid #dee2e6;
                }
                .total-section {
                    background-color: #f8f9fa;
                    padding: 20px;
                    border-radius: 5px;
                    margin: 20px 0;
                }
                .terms {
                    border-top: 1px solid #dee2e6;
                    padding-top: 20px;
                    margin-top: 30px;
                    font-size: 0.9em;
                    color: #6c757d;
                }
                .watermark {
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%) rotate(-45deg);
                    font-size: 80px;
                    opacity: 0.1;
                    color: #007bff;
                    z-index: -1;
                    pointer-events: none;
                }
            </style>
        </head>
        <body>
            <div class="container invoice-container">
                ${invoiceHtml}
            </div>
            <div class="watermark">HAKIKA</div>
            <script>
                window.onload = function() {
                    window.print();
                    setTimeout(function() {
                        window.close();
                    }, 500);
                };
            <\/script>
        </body>
        </html>
    `);

        printWindow.document.close();
    }

    function generateInvoiceHTML(transaction) {
        const invoiceDate = new Date(transaction.createdAt);
        const dueDate = new Date(invoiceDate);
        dueDate.setDate(dueDate.getDate() + 30);

        const items = [
            {
                description: transaction.description,
                quantity: 1,
                unitPrice: Math.abs(transaction.amount),
                amount: Math.abs(transaction.amount)
            }
        ];

        const subtotal = items.reduce((sum, item) => sum + item.amount, 0);
        const tax = 0; // Adjust if you have tax
        const total = subtotal + tax;

        return `
        <!-- Invoice Header -->
        <div class="invoice-header">
            <div class="row">
                <div class="col-md-6">
                    <h1 class="invoice-title">INVOICE</h1>
                    <p class="text-muted mb-1">Invoice #: INV-${transaction.id.slice(-8).toUpperCase()}</p>
                    <p class="text-muted mb-1">Date: ${invoiceDate.toLocaleDateString()}</p>
                    <p class="text-muted">Due Date: ${dueDate.toLocaleDateString()}</p>
                </div>
                <div class="col-md-6 company-info">
                    <h4 class="fw-bold text-primary">Hakika Verification</h4>
                    <p class="mb-1">Accra, Ghana</p>
                    <p class="mb-1">support@hakika.com</p>
                    <p class="mb-1">+233 (23) 536-4134</p>
                </div>
            </div>
        </div>
        
        <!-- Bill To -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h5>Bill To:</h5>
                <p class="mb-1"><strong>Fuseni Saeed</strong></p>
                <p class="mb-1">Premium User Account</p>
                <p class="mb-1">Transaction ID: ${transaction.id}</p>
            </div>
            <div class="col-md-6 text-end">
                <div class="alert alert-info">
                    <h6 class="mb-1">Payment Status</h6>
                    <span class="badge bg-${getStatusColor(transaction.status)}">
                        ${transaction.status.toUpperCase()}
                    </span>
                    <p class="mb-0 small mt-2">Paid on: ${invoiceDate.toLocaleDateString()}</p>
                </div>
            </div>
        </div>
        
        <!-- Items Table -->
        <table class="invoice-table">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Quantity</th>
                    <th>Unit Price</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                ${items.map(item => `
                    <tr>
                        <td>${item.description}</td>
                        <td>${item.quantity}</td>
                        <td>$${item.unitPrice.toFixed(2)}</td>
                        <td>$${item.amount.toFixed(2)}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        
        <!-- Totals -->
        <div class="row justify-content-end">
            <div class="col-md-4">
                <div class="total-section">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span>$${subtotal.toFixed(2)}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tax:</span>
                        <span>$${tax.toFixed(2)}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Total:</span>
                        <span class="text-success">$${total.toFixed(2)} ${transaction.currency}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Payment Details -->
        <div class="row mt-4">
            <div class="col-md-6">
                <h6>Payment Details</h6>
                <p class="mb-1"><strong>Method:</strong> ${transaction.paymentMethod}</p>
                ${transaction.gatewayReference ?
                `<p class="mb-1"><strong>Reference:</strong> ${transaction.gatewayReference}</p>` : ''}
                <p class="mb-1"><strong>Currency:</strong> ${transaction.currency}</p>
            </div>
            <div class="col-md-6">
                <h6>Additional Information</h6>
                ${transaction.metadata ? `
                    <p class="small mb-1">Verification: ${transaction.metadata.referenceNumber || 'N/A'}</p>
                ` : ''}
                <p class="small mb-1">Invoice generated electronically</p>
            </div>
        </div>
        
        <!-- Terms -->
        <div class="terms">
            <h6>Terms & Conditions</h6>
            <p class="small mb-2">
                1. This is an electronically generated invoice.
            </p>
            <p class="small mb-2">
                2. Payment is due within 30 days of invoice date.
            </p>
            <p class="small mb-2">
                3. For any queries, contact support@hakika.com
            </p>
            <p class="small mb-0">
                4. Thank you for choosing Hakika Verification Services.
            </p>
        </div>
    `;
    }

    function createPrintableReceipt(content) {
        // Create a temporary div to parse the content
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;

        // Extract transaction data
        const transactionId = tempDiv.querySelector('#transactionId')?.textContent || 'N/A';
        const transactionType = tempDiv.querySelector('#transactionType')?.textContent || 'N/A';
        const transactionAmount = tempDiv.querySelector('#transactionAmount')?.textContent || 'N/A';
        const transactionStatus = tempDiv.querySelector('#transactionStatus')?.textContent || 'N/A';
        const transactionDate = tempDiv.querySelector('#transactionDate')?.textContent || 'N/A';
        const transactionDescription = tempDiv.querySelector('#transactionDescription')?.textContent || 'N/A';

        // Get current date for receipt
        const now = new Date();
        const receiptNumber = `RCPT-${Date.now().toString().slice(-8)}`;

        // Create print-optimized receipt
        return `
        <div class="receipt-header">
            <div class="receipt-title">
                <i class="fas fa-receipt me-2"></i>Transaction Receipt
            </div>
            <p class="text-muted">Official receipt for your transaction</p>
        </div>
        
        <div class="row receipt-info">
            <div class="col-md-6">
                <div class="receipt-section">
                    <h5><i class="fas fa-info-circle me-2"></i>Transaction Details</h5>
                    <div class="d-flex mb-2">
                        <span class="receipt-label">Receipt Number:</span>
                        <span class="receipt-value ms-2">${receiptNumber}</span>
                    </div>
                    <div class="d-flex mb-2">
                        <span class="receipt-label">Transaction ID:</span>
                        <span class="receipt-value ms-2">${transactionId}</span>
                    </div>
                    <div class="d-flex mb-2">
                        <span class="receipt-label">Date & Time:</span>
                        <span class="receipt-value ms-2">${transactionDate || now.toLocaleString()}</span>
                    </div>
                    <div class="d-flex mb-2">
                        <span class="receipt-label">Status:</span>
                        <span class="receipt-value ms-2">
                            <span class="status-badge ${getStatusClass(transactionStatus)}">
                                ${transactionStatus}
                            </span>
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="receipt-section">
                    <h5><i class="fas fa-money-bill-wave me-2"></i>Payment Details</h5>
                    <div class="d-flex mb-2">
                        <span class="receipt-label">Transaction Type:</span>
                        <span class="receipt-value ms-2">${transactionType}</span>
                    </div>
                    <div class="d-flex mb-2">
                        <span class="receipt-label">Amount:</span>
                        <span class="receipt-value ms-2 ${getAmountClass(transactionAmount)}">
                            ${transactionAmount}
                        </span>
                    </div>
                    <div class="d-flex mb-2">
                        <span class="receipt-label">Payment Method:</span>
                        <span class="receipt-value ms-2">${getPaymentMethod(transactionType)}</span>
                    </div>
                    <div class="d-flex">
                        <span class="receipt-label">Description:</span>
                        <span class="receipt-value ms-2">${transactionDescription}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="receipt-section">
            <h5><i class="fas fa-file-invoice me-2"></i>Additional Information</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Customer:</strong> Fuseni Saeed</p>
                    <p><strong>Account Type:</strong> Premium</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Platform:</strong> Hakika Verification System</p>
                    <p><strong>Service:</strong> Academic Credential Verification</p>
                </div>
            </div>
            
            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Note:</strong> This receipt serves as proof of transaction. 
                Please keep it for your records.
            </div>
        </div>
        
        <div class="print-actions mt-4 text-center">
            <button class="btn btn-primary me-2" onclick="window.print()">
                <i class="fas fa-print me-2"></i>Print Now
            </button>
            <button class="btn btn-outline-primary" onclick="window.close()">
                <i class="fas fa-times me-2"></i>Close
            </button>
        </div>
    `;
    }

    function getStatusClass(status) {
        const statusLower = status.toLowerCase();
        if (statusLower.includes('success') || statusLower.includes('complete') || statusLower.includes('paid')) {
            return 'status-success';
        } else if (statusLower.includes('pending') || statusLower.includes('processing')) {
            return 'status-pending';
        } else if (statusLower.includes('fail') || statusLower.includes('cancel') || statusLower.includes('error')) {
            return 'status-failed';
        }
        return 'status-pending';
    }

    function getAmountClass(amount) {
        if (amount.startsWith('+') || amount.includes('Credit')) {
            return 'amount-positive';
        } else if (amount.startsWith('-') || amount.includes('Debit') || amount.includes('Fee')) {
            return 'amount-negative';
        }
        return '';
    }

    function getPaymentMethod(transactionType) {
        const typeLower = transactionType.toLowerCase();
        if (typeLower.includes('card')) {
            return 'Credit/Debit Card';
        } else if (typeLower.includes('bank')) {
            return 'Bank Transfer';
        } else if (typeLower.includes('mobile')) {
            return 'Mobile Money';
        } else if (typeLower.includes('wallet')) {
            return 'Wallet Balance';
        }
        return 'System Transaction';
    }

    function downloadReceipt() {
        const modalContent = document.getElementById('transactionDetailsContent');
        if (!modalContent) return;

        const receiptContent = createPrintableReceipt(modalContent.innerHTML);
        const blob = new Blob([receiptContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `receipt-${Date.now()}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    async function shareTransaction(transactionId) {
        try {
            // Fetch transaction details
            const transaction = await fetchTransactionDetails(transactionId);

            if (!transaction) {
                showToast('error', 'Transaction not found');
                return;
            }

            // Create share options
            showShareOptions(transaction);

        } catch (error) {
            console.error('Error sharing transaction:', error);
            showToast('error', 'Failed to share transaction');
        }
    }

    function showShareOptions(transaction) {
        // Create or get share modal
        let shareModal = document.getElementById('shareModal');
        if (!shareModal) {
            shareModal = createShareModal();
            document.body.appendChild(shareModal);
        }

        // Generate share content
        const shareUrl = `${window.location.origin}/transactions/${transaction.id}`;
        const shareText = `Transaction: ${transaction.description}\n` +
            `Amount: $${transaction.amount} ${transaction.currency}\n` +
            `Status: ${transaction.status}\n` +
            `Date: ${new Date(transaction.createdAt).toLocaleDateString()}`;

        // Update modal content
        const shareContent = shareModal.querySelector('#shareContent');
        if (shareContent) {
            shareContent.innerHTML = `
            <div class="share-preview mb-4 p-3 bg-light rounded">
                <h6 class="mb-2">Preview:</h6>
                <p class="mb-1"><strong>${transaction.description}</strong></p>
                <p class="mb-1">Amount: <span class="fw-bold">$${transaction.amount} ${transaction.currency}</span></p>
                <p class="mb-1">Status: <span class="badge bg-${getStatusColor(transaction.status)}">${transaction.status}</span></p>
                <p class="mb-0 small text-muted">${new Date(transaction.createdAt).toLocaleString()}</p>
            </div>
            
            <div class="share-options">
                <!-- Share URL -->
                <div class="mb-3">
                    <label class="form-label small">Share Link</label>
                    <div class="input-group">
                        <input type="text" class="form-control" value="${shareUrl}" id="shareUrl" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('shareUrl')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Share Text -->
                <div class="mb-4">
                    <label class="form-label small">Share Text</label>
                    <textarea class="form-control" rows="3" id="shareText" readonly>${shareText}</textarea>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('shareText')">
                            <i class="fas fa-copy me-1"></i>Copy Text
                        </button>
                    </div>
                </div>
                
                <!-- Share Buttons -->
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-primary flex-fill" onclick="shareViaEmail('${transaction.id}')">
                        <i class="fas fa-envelope me-1"></i>Email
                    </button>
                    ${navigator.share ? `
                        <button class="btn btn-outline-info flex-fill" onclick="shareViaNative('${transaction.id}')">
                            <i class="fas fa-share-alt me-1"></i>Share
                        </button>
                    ` : ''}
                    <button class="btn btn-outline-success flex-fill" onclick="downloadAsPDF('${transaction.id}')">
                        <i class="fas fa-file-pdf me-1"></i>PDF
                    </button>
                </div>
            </div>
        `;
        }

        // Show the modal
        const modal = new bootstrap.Modal(shareModal);
        modal.show();
    }

    // Share via Email
    function shareViaEmail(transactionId) {
        const subject = encodeURIComponent('Transaction Details from Hakika');
        const body = encodeURIComponent(
            `Please find the transaction details below:\n\n` +
            `Transaction ID: ${transactionId}\n` +
            `View details: ${window.location.origin}/transactions/${transactionId}`
        );
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
    }

    async function shareViaNative(transactionId) {
        try {
            const transaction = await fetchTransactionDetails(transactionId);
            const shareData = {
                title: 'Transaction Details - Hakika',
                text: `Transaction: ${transaction.description}\nAmount: $${transaction.amount} ${transaction.currency}`,
                url: `${window.location.origin}/transactions/${transactionId}`
            };

            if (navigator.share) {
                await navigator.share(shareData);
                showToast('success', 'Transaction shared successfully');
            }
        } catch (error) {
            if (error.name !== 'AbortError') {
                console.error('Error sharing:', error);
                showToast('error', 'Failed to share');
            }
        }
    }

    // Download as PDF
    function downloadAsPDF(transactionId) {
        showToast('info', 'PDF download feature coming soon');
        // Implementation would require a PDF library like jsPDF
        // You can integrate jsPDF: https://github.com/parallax/jsPDF
    }

    // Copy to clipboard helper
    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        element.select();
        element.setSelectionRange(0, 99999); // For mobile devices

        navigator.clipboard.writeText(element.value).then(() => {
            showToast('success', 'Copied to clipboard!');
        }).catch(err => {
            console.error('Failed to copy:', err);
            showToast('error', 'Failed to copy');
        });
    }

    function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString();
    }

    function showToast(type, message) {
        const toastId = type === 'success' ? 'successToast' : 'errorToast';
        const toastElement = document.getElementById(toastId);
        const toastBody = document.getElementById(`${toastId}Message`);

        if (toastElement && toastBody) {
            toastBody.textContent = message;
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }
    }

    function formatTime(dateString) {
        return new Date(dateString).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Fetch transaction details
    async function fetchTransactionDetails(transactionId) {
        try {
            const response = await fetch(`/transactions/api/${transactionId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            return data.data || data;

        } catch (error) {
            console.error('Error fetching transaction:', error);
            return null;
        }
    }

    // Create Receipt Modal
    function createReceiptModal() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'receiptModal';
        modal.tabIndex = -1;
        modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-receipt me-2"></i>Transaction Receipt
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="receiptContent">
                    <!-- Receipt content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="printReceiptBtn">
                        <i class="fas fa-print me-2"></i>Print Receipt
                    </button>
                </div>
            </div>
        </div>
    `;
        return modal;
    }

    // Create Share Modal
    function createShareModal() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'shareModal';
        modal.tabIndex = -1;
        modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-share-alt me-2"></i>Share Transaction
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="shareContent">
                    <!-- Share options will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    `;
        return modal;
    }

    function printReceiptContent(content, transaction) {
        const printWindow = window.open('', '_blank', 'width=800,height=600');

        printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Receipt - ${transaction.id}</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
            <style>
                @media print {
                    body { margin: 0; padding: 20px; }
                    .no-print { display: none !important; }
                    .receipt-container { max-width: 100% !important; }
                }
                @page {
                    margin: 0.5cm;
                }
                body {
                    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                }
                .receipt-logo {
                    color: #007bff;
                }
                .amount-section {
                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                }
            </style>
        </head>
        <body>
            <div class="container">
                ${content}
                <div class="text-center mt-5 pt-4 border-top">
                    <p class="text-muted small">
                        <i class="fas fa-lock me-1"></i>
                        Secured Transaction  Generated on ${new Date().toLocaleString()}
                    </p>
                </div>
            </div>
            <script>
                window.onload = function() {
                    window.print();
                    setTimeout(function() {
                        window.close();
                    }, 500);
                };
            <\/script>
        </body>
        </html>
    `);

        printWindow.document.close();
    }

    // Toast notification function
    function showToast(type, message) {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : 'success'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');

        toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

        // Add to toast container
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }

        toastContainer.appendChild(toast);

        // Initialize and show toast
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();

        // Remove after hiding
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }

    function showActiveFilters() {
        const activeFilters = [];

        if (TransactionsService.currentFilters.status !== 'all') {
            activeFilters.push(`Status: ${TransactionsService.currentFilters.status}`);
        }

        if (TransactionsService.currentFilters.paymentMethod !== 'all') {
            activeFilters.push(`Method: ${TransactionsService.currentFilters.paymentMethod}`);
        }

        if (TransactionsService.currentFilters.search) {
            activeFilters.push(`Search: "${TransactionsService.currentFilters.search}"`);
        }

        if (TransactionsService.currentFilters.dateRange !== 'week') {
            activeFilters.push(`Date: ${TransactionsService.currentFilters.dateRange}`);
        }

        // Create or update active filters display
        let filtersDisplay = document.getElementById('activeFiltersDisplay');
        if (!filtersDisplay) {
            filtersDisplay = document.createElement('div');
            filtersDisplay.id = 'activeFiltersDisplay';
            filtersDisplay.className = 'active-filters mt-3';
            document.querySelector('.page-header').appendChild(filtersDisplay);
        }

        if (activeFilters.length > 0) {
            filtersDisplay.innerHTML = `
            <div class="d-flex align-items-center flex-wrap gap-2">
                <span class="text-muted small">Active filters:</span>
                ${activeFilters.map(filter => `
                    <span class="badge bg-info">
                        ${filter}
                        <button class="btn-close btn-close-white btn-close-sm ms-1" onclick="removeFilter('${filter.split(':')[0].trim().toLowerCase()}')"></button>
                    </span>
                `).join('')}
            </div>
        `;
        } else {
            filtersDisplay.innerHTML = '';
        }
    }

    // Function to remove specific filter
    function removeFilter(filterType) {
        switch (filterType) {
            case 'status':
                TransactionsService.currentFilters.status = 'all';
                document.getElementById('statusFilter').value = 'all';
                break;
            case 'method':
                TransactionsService.currentFilters.paymentMethod = 'all';
                document.getElementById('paymentMethodFilter').value = 'all';
                break;
            case 'search':
                TransactionsService.currentFilters.search = '';
                document.getElementById('tableSearch').value = '';
                break;
            case 'date':
                TransactionsService.currentFilters.dateRange = 'week';
                document.getElementById('dateRange').value = 'week';
                break;
        }
        TransactionsService.applyFilters();
    }
</script>

<style>
    /* Refund Modal Styles */
    #refundModal .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    #refundModal .modal-header {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 1rem 1.5rem;
    }

    #refundModal .modal-header .btn-close {
        filter: invert(1) brightness(200%);
    }

    #refundModal .modal-body {
        padding: 1.5rem;
        max-height: 70vh;
        overflow-y: auto;
    }

    #refundModal .transaction-details {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 1px solid #fbbf24;
    }

    #refundModal .refund-checkbox:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }

    #refundModal table td {
        vertical-align: middle;
    }

    #refundModal .badge.bg-success {
        background-color: #10b981 !important;
    }

    #refundModal .badge.bg-secondary {
        background-color: #6b7280 !important;
    }

    /* Single Refund Modal */
    #singleRefundModal .modal-header {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }

    #singleRefundModal .alert-warning {
        background-color: #fffbeb;
        border-color: #fbbf24;
        color: #92400e;
    }

    /* Report Modals */
    #reconciliationReportModal .modal-content,
    #refundReportModal .modal-content {
        border-radius: 12px;
    }

    #reconciliationReportModal .modal-header,
    #refundReportModal .modal-header {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
    }

    #reconciliationReportModal .card,
    #refundReportModal .card {
        border: none;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }

    #reconciliationReportModal .card:hover,
    #refundReportModal .card:hover {
        transform: translateY(-2px);
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
        #refundModal .modal-dialog {
            margin: 0.5rem;
        }

        #refundModal .row {
            flex-direction: column;
        }

        #refundModal .col-md-6 {
            width: 100%;
            margin-bottom: 1rem;
        }

        #refundModal .table-responsive {
            font-size: 0.875rem;
        }
    }

    .viewall-transactions-page {
        padding: 1.5rem;
        background: #f8f9fa;
        min-height: 100vh;
    }

    .page-header {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .stat-card {
        border: none;
        border-radius: 12px;
        transition: transform 0.2s;
        cursor: pointer;
    }

    .stat-card:hover {
        transform: translateY(-3px);
    }

    .status-badge {
        padding: 0.35rem 0.75rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-completed {
        background: #d1fae5;
        color: #10b981;
    }

    .status-pending {
        background: #fef3c7;
        color: #f59e0b;
    }

    .status-failed {
        background: #fee2e2;
        color: #dc2626;
    }

    .status-refunded {
        background: #dbeafe;
        color: #3b82f6;
    }

    .status-disputed {
        background: #f3e8ff;
        color: #8b5cf6;
    }

    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
    }

    .transaction-row:hover {
        background-color: #f8f9fa;
    }

    .amount-cell {
        text-align: right;
    }

    .summary-item .progress {
        background-color: #e9ecef;
    }

    .distribution-item {
        padding: 0.25rem 0;
        border-bottom: 1px solid #f1f3f5;
    }

    .distribution-item:last-child {
        border-bottom: none;
    }

    .detail-item label {
        font-size: 0.75rem;
        margin-bottom: 0.25rem;
    }

    .detail-item p {
        font-size: 0.9rem;
    }

    .table th {
        font-weight: 600;
        color: #495057;
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        padding: 0.75rem;
    }

    .table td {
        padding: 0.75rem;
        vertical-align: middle;
    }

    /* Add Transaction Modal Styles */
    #addTransactionModal .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    #addTransactionModal .accordion-button {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
    }

    #addTransactionModal .accordion-button:not(.collapsed) {
        background-color: rgba(79, 70, 229, 0.05);
        color: #4F46E5;
    }

    #addTransactionModal .accordion-body {
        padding: 1rem;
        background-color: #f8f9fa;
    }

    #addTransactionModal .input-group-text {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }

    #addTransactionModal .was-validated .form-control:invalid {
        border-color: #dc3545;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }

    #addTransactionModal .was-validated .form-control:valid {
        border-color: #198754;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }

    @media (max-width: 768px) {
        .viewall-transactions-page {
            padding: 1rem;
        }

        .stat-card .d-flex {
            flex-direction: column;
            text-align: center;
        }

        .stat-card i {
            margin-top: 10px;
        }

        .table-responsive {
            font-size: 0.875rem;
        }

        .action-buttons .btn-group {
            width: 100%;
            flex-wrap: wrap;
        }
    }
</style>