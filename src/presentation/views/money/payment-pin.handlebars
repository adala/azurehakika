<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
            <div class="card">
                <div class="card-header text-center">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-lock me-2"></i>Confirm Payment
                    </h4>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-shield-alt text-primary display-4 mb-3"></i>
                        <p class="text-muted">
                            {{#if (eq paymentMethod 'momo')}}
                            Enter the PIN from your Mobile Money app to complete the payment.
                            {{else}}
                            Enter your card's security PIN to authorize this transaction.
                            {{/if}}
                        </p>
                    </div>

                    <form id="pinForm">
                        <div class="mb-4">
                            <label for="pin" class="form-label">Enter PIN</label>
                            <input type="password" 
                                   class="form-control form-control-lg text-center" 
                                   id="pin" 
                                   maxlength="4" 
                                   pattern="[0-9]{4}" 
                                   placeholder="****"
                                   required
                                   autocomplete="off">
                            <div class="form-text">
                                {{#if (eq paymentMethod 'momo')}}
                                Check your phone for the payment request and enter your MoMo PIN
                                {{else}}
                                Enter your 4-digit card PIN
                                {{/if}}
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitPinBtn">
                                <i class="fas fa-check me-2"></i>Confirm Payment
                            </button>
                            <a href="/dashboard/payment/processing?reference={{paymentReference}}&method={{paymentMethod}}" 
                               class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back
                            </a>
                        </div>
                    </form>

                    <!-- Security Notice -->
                    <div class="alert alert-light mt-4">
                        <div class="d-flex">
                            <i class="fas fa-info-circle text-info me-2 mt-1"></i>
                            <small>
                                Your PIN is processed securely and never stored on our servers.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const paymentReference = '{{paymentReference}}';
const paymentMethod = '{{paymentMethod}}';

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('pinForm').addEventListener('submit', handlePinSubmission);
    document.getElementById('pin').focus();
});

async function handlePinSubmission(event) {
    event.preventDefault();
    
    const pin = document.getElementById('pin').value;
    
    if (!pin || pin.length !== 4) {
        alert('Please enter a valid 4-digit PIN');
        return;
    }
    
    // Show loading state
    const submitBtn = document.getElementById('submitPinBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verifying...';
    
    try {
        const response = await fetch('/api/payment/confirm-pin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getAuthToken()
            },
            body: JSON.stringify({
                paymentReference: paymentReference,
                pin: pin
            })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.message || 'PIN verification failed');
        }
        
        if (result.success) {
            // PIN accepted, redirect to processing
            window.location.href = `/dashboard/payment/processing?reference=${paymentReference}&method=${paymentMethod}`;
        } else {
            throw new Error(result.message || 'Invalid PIN');
        }
        
    } catch (error) {
        alert('PIN verification failed: ' + error.message);
        
        // Reset button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Confirm Payment';
        
        // Clear PIN field
        document.getElementById('pin').value = '';
        document.getElementById('pin').focus();
    }
}
</script>