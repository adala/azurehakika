<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="text-center">
                <div class="spinner-border text-primary mb-4" style="width: 4rem; height: 4rem;" role="status">
                    <span class="visually-hidden">Processing...</span>
                </div>

                <h2 class="h3 mb-3">Processing Your Payment</h2>

                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Payment Details</h5>
                        <div class="row text-start">
                            <div class="col-6">
                                <small class="text-muted">Reference:</small>
                                <p class="mb-1"><strong>{{reference}}</strong></p>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Amount:</small>
                                <p class="mb-1"><strong>{{currency}} {{amount}}</strong></p>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Method:</small>
                                <p class="mb-1"><strong>{{method}}</strong></p>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Status:</small>
                                <p class="mb-1"><span id="statusText" class="badge bg-warning">Processing</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                {{#if requiresPin}}
                <div class="card mb-4" id="pinSection">
                    <div class="card-body">
                        <h5 class="card-title">Enter PIN</h5>
                        <p class="text-muted">Please enter your card PIN to complete the transaction</p>
                        <div class="row justify-content-center">
                            <div class="col-md-6">
                                <input type="password" class="form-control text-center" id="pinInput" maxlength="4"
                                    placeholder="Enter 4-digit PIN" pattern="[0-9]{4}">
                                <button class="btn btn-primary mt-3 w-100" onclick="submitPin()">
                                    Submit PIN
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {{/if}}

                {{#if requiresOTP}}
                <div class="card mb-4" id="otpSection">
                    <div class="card-body">
                        <h5 class="card-title">Enter OTP</h5>
                        <p class="text-muted">Please enter the OTP sent to your registered phone number</p>
                        <div class="row justify-content-center">
                            <div class="col-md-6">
                                <input type="text" class="form-control text-center" id="otpInput" maxlength="6"
                                    placeholder="Enter 6-digit OTP" pattern="[0-9]{6}">
                                <button class="btn btn-primary mt-3 w-100" onclick="submitOTP()">
                                    Submit OTP
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {{/if}}

                <div class="alert alert-info">
                    <small>
                        <i class="fas fa-info-circle me-2"></i>
                        Please do not close or refresh this page while processing.
                    </small>
                </div>

                <div id="successSection" style="display: none;">
                    <i class="fas fa-check-circle text-success display-1 mb-3"></i>
                    <h4 class="mb-3">Payment Successful!</h4>
                    <p>Your wallet has been credited successfully.</p>
                    <button class="btn btn-primary" onclick="redirectToWallet()">
                        Go to Wallet
                    </button>
                </div>

                <div id="errorSection" style="display: none;">
                    <i class="fas fa-times-circle text-danger display-1 mb-3"></i>
                    <h4 class="mb-3">Payment Failed</h4>
                    <p id="errorMessage"></p>
                    <button class="btn btn-outline-primary" onclick="retryPayment()">
                        Try Again
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let checkInterval;
    const reference = "{{reference}}";

    document.addEventListener('DOMContentLoaded', function () {
        startPaymentCheck();
    });

    function startPaymentCheck() {
        checkInterval = setInterval(checkPaymentStatus, 3000);

        // First check immediately
        setTimeout(checkPaymentStatus, 1000);
    }

    async function checkPaymentStatus() {
        try {
            const response = await fetch(`/payments/status/${reference}`, {
                headers: {
                    'Authorization': 'Bearer ' + getAuthToken()
                }
            });

            const result = await response.json();

            if (result.success) {
                updateStatusDisplay(result.data);

                if (result.data.status === 'completed') {
                    clearInterval(checkInterval);
                    showSuccess();
                } else if (result.data.status === 'failed') {
                    clearInterval(checkInterval);
                    showError(result.data.metadata?.error || 'Payment failed');
                }
            }
        } catch (error) {
            console.error('Error checking payment status:', error);
        }
    }

    function updateStatusDisplay(data) {
        const statusText = document.getElementById('statusText');
        if (statusText) {
            statusText.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);

            // Update badge color based on status
            const badgeClasses = {
                'pending': 'bg-warning',
                'processing': 'bg-info',
                'completed': 'bg-success',
                'failed': 'bg-danger'
            };

            statusText.className = `badge ${badgeClasses[data.status] || 'bg-warning'}`;
        }
    }

    async function submitPin() {
        const pin = document.getElementById('pinInput').value;

        if (pin.length !== 4) {
            alert('Please enter a valid 4-digit PIN');
            return;
        }

        try {
            const response = await fetch('/payments/submit-pin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + getAuthToken()
                },
                body: JSON.stringify({ reference, pin })
            });

            const result = await response.json();

            if (result.success) {
                showSuccess();
            } else {
                showError(result.message);
            }
        } catch (error) {
            showError('Failed to submit PIN');
        }
    }

    async function submitOTP() {
        const otp = document.getElementById('otpInput').value;

        if (otp.length !== 6) {
            alert('Please enter a valid 6-digit OTP');
            return;
        }

        try {
            const response = await fetch('/payments/submit-otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + getAuthToken()
                },
                body: JSON.stringify({ reference, otp })
            });

            const result = await response.json();

            if (result.success) {
                showSuccess();
            } else {
                showError(result.message);
            }
        } catch (error) {
            showError('Failed to submit OTP');
        }
    }

    function showSuccess() {
        clearInterval(checkInterval);
        document.querySelector('.spinner-border').style.display = 'none';
        document.querySelector('h2').style.display = 'none';
        document.getElementById('successSection').style.display = 'block';
        document.getElementById('pinSection')?.style.display = 'none';
        document.getElementById('otpSection')?.style.display = 'none';
    }

    function showError(message) {
        clearInterval(checkInterval);
        document.querySelector('.spinner-border').style.display = 'none';
        document.querySelector('h2').style.display = 'none';
        document.getElementById('errorSection').style.display = 'block';
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('pinSection')?.style.display = 'none';
        document.getElementById('otpSection')?.style.display = 'none';
    }

    function redirectToWallet() {
        window.location.href = '/payments/wallet';
    }

    function retryPayment() {
        window.location.href = '/payments/add-funds';
    }

    function getAuthToken() {
        // Implement based on your auth system
        return localStorage.getItem('token');
    }
</script>