{{! viewall-verifications.handlebars - For use within main layout }}
<div class="viewall-verifications-page">
    <!-- Header with Actions -->
    <div class="page-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2">Verification Requests</h1>
                <p class="text-muted mb-0">Manage and track all verification requests</p>
            </div>
            <div class="action-buttons">
                <div class="btn-group" role="group">
                    <button class="btn btn-primary" id="newVerificationBtn">
                        <i class="fas fa-plus me-2"></i>New Verification
                    </button>
                    <button class="btn btn-outline-primary" id="filterBtn" data-bs-toggle="dropdown">
                        <i class="fas fa-filter me-2"></i>Filter
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" data-filter="all">All</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="pending">Pending</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="processing">Processing</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="completed">Completed</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="failed">Failed</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="#" data-filter="today">Today</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="week">This Week</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="month">This Month</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Total Verifications</h6>
                            <h3 class="mb-0" id="totalCount">0</h3>
                        </div>
                        <i class="fas fa-file-alt fa-2x opacity-50"></i>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar bg-white" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Completed</h6>
                            <h3 class="mb-0" id="completedCount">0</h3>
                        </div>
                        <i class="fas fa-check-circle fa-2x opacity-50"></i>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar bg-white" id="completedProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">In-progress</h6>
                            <h3 class="mb-0" id="processingCount">0</h3>
                        </div>
                        <i class="fas fa-sync-alt fa-2x opacity-50"></i>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar bg-white" id="processingProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Pending</h6>
                            <h3 class="mb-0" id="failedCount">0</h3>
                        </div>
                        <i class="fas fa-times-circle fa-2x opacity-50"></i>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar bg-white" id="failedProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Bulk Actions -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-8">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control border-start-0" id="searchInput"
                            placeholder="Search by name, student ID, reference number...">
                        <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                            Clear
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex gap-2">
                        <select class="form-select" id="bulkActionSelect">
                            <option value="">Bulk Actions</option>
                            <option value="export">Export Selected</option>
                            <option value="resend">Resend Notifications</option>
                            <option value="archive">Archive Selected</option>
                            <option value="delete">Delete Selected</option>
                        </select>
                        <button class="btn btn-outline-primary" id="applyBulkAction">Apply</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Verifications Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Recent Verification Requests</h5>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small" id="showingCount">Showing 0 items</span>
                <button class="btn btn-sm btn-outline-secondary" id="refreshBtn">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="verificationsTable">
                    <thead>
                        <tr>
                            <th width="30">
                                <input type="checkbox" class="form-check-input" id="selectAll">
                            </th>
                            <th>Reference</th>
                            <th>Student</th>
                            <th>Institution</th>
                            <th>Status</th>
                            <th>Score</th>
                            <th>Created</th>
                            <th>Fee</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="verificationsTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted small">
                    Showing <span id="startCount">0</span> to <span id="endCount">0</span> of <span
                        id="totalItems">0</span> entries
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="pagination">
                        <!-- Pagination will be generated here -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Status Legend -->
    <div class="mt-4">
        <div class="d-flex gap-3">
            <div class="d-flex align-items-center">
                <span class="status-indicator status-pending me-2"></span>
                <small>Pending</small>
            </div>
            <div class="d-flex align-items-center">
                <span class="status-indicator status-processing me-2"></span>
                <small>Processing</small>
            </div>
            <div class="d-flex align-items-center">
                <span class="status-indicator status-completed me-2"></span>
                <small>Completed</small>
            </div>
            <div class="d-flex align-items-center">
                <span class="status-indicator status-failed me-2"></span>
                <small>Failed</small>
            </div>
        </div>
    </div>
</div>

<!-- Empty State Template -->
<template id="emptyStateTemplate">
    <tr>
        <td colspan="9">
            <div class="text-center py-5">
                <i class="fas fa-file-alt fa-4x text-muted mb-3"></i>
                <h5 class="text-muted mb-3">No verification requests found</h5>
                <p class="text-muted mb-4">Get started by creating your first verification request</p>
                <button class="btn btn-primary" id="createFirstVerification">
                    <i class="fas fa-plus me-2"></i>Create Verification
                </button>
            </div>
        </td>
    </tr>
</template>

<!-- Row Template -->
<template id="verificationRowTemplate">
    <tr data-id="{{id}}" class="verification-row">
        <td>
            <input type="checkbox" class="form-check-input row-select" value="{{id}}">
        </td>
        <td>
            <div>
                <strong class="d-block" data-bind="referenceNumber">#{{referenceNumber}}</strong>
                <small class="text-muted" data-bind="id">{{id}}</small>
            </div>
        </td>
        <td>
            <div>
                <strong class="d-block" data-bind="firstName">{{firstName}}</strong>
                <strong class="d-block" data-bind="lastName">{{lastName}}</strong>
                <small class="text-muted" data-bind="studentId">{{studentId}}</small>
            </div>
        </td>
        <td>
            <div class="d-flex align-items-center">
                <img src="{{Institution.logo}}" alt="{{Institution.name}}" class="institution-logo-sm me-2"
                    data-bind-logo="{{Institution.logo}}">
                <div>
                    <div class="d-block" data-bind="institutionName">{{Institution.name}}</div>
                    <small class="text-muted" data-bind="process">{{process}}</small>
                </div>
            </div>
        </td>
        <td>
            <span class="status-badge" data-bind="status">{{status}}</span>
        </td>
        <td data-bind="scoreContainer">
            {{#if verifications}}
            <div class="score-display">
                <div class="progress" style="height: 6px; width: 60px;">
                    <div class="progress-bar" data-bind-score="{{verificationScore}}"
                        style="width: {{verificationScore}}%"></div>
                </div>
                <small data-bind-score-text="{{verificationScore}}">{{verificationScore}}%</small>
            </div>
            {{else}}
            <span class="text-muted">-</span>
            {{/if}}
        </td>
        <td>
            <div data-bind-date="{{createdAt}}">{{formatDate createdAt}}</div>
            <small class="text-muted" data-bind-time="{{createdAt}}">{{formatTime createdAt}}</small>
        </td>
        <td>
            <span class="badge bg-light text-dark" data-bind="fee">${{fee}}</span>
        </td>
        <td class="text-end">
            <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-primary view-btn" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item download-report-btn" href="#" data-id="{{id}}">
                            <i class="fas fa-download me-2"></i>Download Report
                        </a></li>
                    <li><a class="dropdown-item resend-btn" href="#" data-id="{{id}}">
                            <i class="fas fa-redo me-2"></i>Resend
                        </a></li>
                    <li><a class="dropdown-item share-btn" href="#" data-id="{{id}}">
                            <i class="fas fa-share me-2"></i>Share
                        </a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li><a class="dropdown-item text-danger delete-btn" href="#" data-id="{{id}}">
                            <i class="fas fa-trash me-2"></i>Delete
                        </a></li>
                </ul>
            </div>
        </td>
    </tr>
</template>

<!-- Modals -->
<div class="modal fade" id="newVerificationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Verification Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Quick form or redirect to verification form -->
                <div class="text-center py-4">
                    <i class="fas fa-user-graduate fa-3x text-primary mb-3"></i>
                    <h5>Start a New Verification</h5>
                    <p class="text-muted">Create a new verification request for a student</p>
                    <a href="/api/institutions-page" class="btn btn-primary px-4">Create Verification</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const VerificationsService = {
        currentPage: 1,
        pageSize: 10,
        totalItems: 0,
        currentFilter: 'all',
        currentSearch: '',
        selectedItems: new Set(),

        async loadVerifications(page = 1) {
            try {
                const token = AuthService.getToken();
                if (!token) {
                    AuthService.redirectToLogin();
                    return;
                }

                const params = new URLSearchParams({
                    page: page,
                    limit: this.pageSize,
                    filter: this.currentFilter,
                    search: this.currentSearch
                });

                const response = await fetch(`/verification/view-all?${params}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    this.renderVerifications(data);
                    this.updateStats(data);
                    this.updatePagination(data.verifications?.length || 0, page);
                }
            } catch (error) {
                console.error('Error loading verifications:', error);
                showToast('error', 'Failed to load verifications');
            }
        },

        renderVerifications(data) {
            const tableBody = document.getElementById('verificationsTableBody');
            const emptyState = document.getElementById('emptyStateTemplate').content.cloneNode(true);
            const rowTemplate = document.getElementById('verificationRowTemplate').content;

            tableBody.innerHTML = '';

            const verifications = data.verifications || data.data || [];
            
            if (verifications.length === 0) {
                tableBody.appendChild(emptyState);
                return;
            }

            verifications.forEach(verification => {
                const row = rowTemplate.cloneNode(true);
                const tr = row.querySelector('tr');
                tr.setAttribute('data-id', verification.id || verification._id);

                // Fill template data
                this.fillVerificationRow(row, verification);

                tableBody.appendChild(row);
            });
        },

        fillVerificationRow(row, verification) {
            // Reference Number
            const refNumber = row.querySelector('[data-bind="referenceNumber"]');
            if (refNumber) refNumber.textContent = `#${verification.referenceNumber || verification.id}`;

            // ID
            const idElement = row.querySelector('[data-bind="id"]');
            if (idElement) idElement.textContent = verification.id?.slice(-8) || verification._id?.slice(-8) || 'N/A';

            // Student Info
            const firstName = row.querySelector('[data-bind="firstName"]');
            if (firstName) firstName.textContent = verification.firstName || 'Unknown';

            const lastName = row.querySelector('[data-bind="lastName"]');
            if (lastName) lastName.textContent = verification.lastName || '';

            const studentId = row.querySelector('[data-bind="studentId"]');
            if (studentId) studentId.textContent = verification.studentId || verification.studentNumber || 'N/A';

            // Institution
            const institutionName = row.querySelector('[data-bind="institutionName"]');
            const process = row.querySelector('[data-bind="process"]');
            const logoImg = row.querySelector('.institution-logo-sm');
            
            if (verification.Institution) {
                if (institutionName) institutionName.textContent = verification.Institution.name || verification.institutionName || 'Unknown';
                if (process) process.textContent = verification.process || 'manual';
                if (logoImg && verification.Institution.logo) {
                    logoImg.src = verification.Institution.logo;
                    logoImg.alt = verification.Institution.name;
                }
            } else {
                if (institutionName) institutionName.textContent = verification.institutionName || 'Unknown';
                if (process) process.textContent = verification.process || 'manual';
                if (logoImg) {
                    logoImg.src = 'https://via.placeholder.com/30';
                    logoImg.alt = 'Institution';
                }
            }

            // Status
            const statusBadge = row.querySelector('.status-badge');
            if (statusBadge) {
                statusBadge.className = `status-badge status-${verification.status}`;
                statusBadge.textContent = verification.status;
            }

            // Score
            const scoreContainer = row.querySelector('[data-bind="scoreContainer"]');
            if (scoreContainer) {
                const verificationScore = verification.verificationScore || verification.score || 0;
                const progressBar = row.querySelector('[data-bind-score]');
                const scoreText = row.querySelector('[data-bind-score-text]');
                
                if (progressBar) {
                    progressBar.style.width = `${verificationScore}%`;
                    progressBar.className = `progress-bar ${this.getScoreColor(verificationScore)}`;
                }
                if (scoreText) scoreText.textContent = `${verificationScore}%`;
            }

            // Date
            const dateElement = row.querySelector('[data-bind-date]');
            const timeElement = row.querySelector('[data-bind-time]');
            if (dateElement) dateElement.textContent = formatDate(verification.createdAt);
            if (timeElement) timeElement.textContent = formatTime(verification.createdAt);

            // Fee
            const feeElement = row.querySelector('[data-bind="fee"]');
            if (feeElement) {
                feeElement.textContent = `$${verification.fee || verification.amount || '0.00'}`;
            }

            // Add event listeners
            this.addRowEventListeners(row, verification);
        },

        addRowEventListeners(row, verification) {
            const viewBtn = row.querySelector('.view-btn');
            if (viewBtn) {
                viewBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.showVerificationDetails(verification);
                });
            }

            // Row click
            const rowElement = row.querySelector('tr');
            if (rowElement) {
                rowElement.style.cursor = 'pointer';
                rowElement.addEventListener('click', (e) => {
                    if (!e.target.closest('button') && !e.target.closest('input')) {
                        this.showVerificationDetails(verification);
                    }
                });
            }

            // Download Report
            const downloadBtn = row.querySelector('.download-report-btn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.downloadReport(verification.id || verification._id);
                });
            }

            // Resend
            const resendBtn = row.querySelector('.resend-btn');
            if (resendBtn) {
                resendBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.resendVerification(verification.id || verification._id);
                });
            }

            // Share
            const shareBtn = row.querySelector('.share-btn');
            if (shareBtn) {
                shareBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.shareVerification(verification.id || verification._id);
                });
            }

            // Delete
            const deleteBtn = row.querySelector('.delete-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.deleteVerification(verification.id || verification._id);
                });
            }

            // Row selection checkbox
            const rowSelect = row.querySelector('.row-select');
            if (rowSelect) {
                rowSelect.addEventListener('change', (e) => {
                    const id = verification.id || verification._id;
                    if (e.target.checked) {
                        this.selectedItems.add(id);
                    } else {
                        this.selectedItems.delete(id);
                    }
                });
            }
        },

        async showVerificationDetails(verification) {
            try {
                const token = AuthService.getToken();
                //const response = await fetch(`/verification/view-details/${verification.id || verification._id}`, {
                  //  headers: {
                    //    'Authorization': `Bearer ${token}`
                    //}
                //});
                const url = `/verification/view-details/${verification.id || verification._id}`;
                window.location.href = `${url}?token=${encodeURIComponent(token)}`;

                //if (response.ok) {
                  //  const data = await response.json();
                    //const verificationDetails = data.data || data;
                    //this.renderVerificationDetailsModal(verificationDetails);
                    
                    //const modal = new bootstrap.Modal(document.getElementById('verificationDetailsModal'));
                    //modal.show();
                //}
            } catch (error) {
                console.error('Error loading verification details:', error);
                showToast('error', 'Failed to load verification details');
            }
        },

        renderVerificationDetailsModal(verification) {
            let modal = document.getElementById('verificationDetailsModal');
            if (!modal) {
                modal = this.createVerificationDetailsModal();
                document.body.appendChild(modal);
            }

            const modalContent = modal.querySelector('.modal-body');
            if (!modalContent) return;

            const formattedDate = new Date(verification.createdAt).toLocaleString();
            const statusColor = this.getStatusColor(verification.status);

            modalContent.innerHTML = `
                <div class="verification-details">
                    <!-- Header -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <div class="institution-logo me-3">
                                    ${verification.Institution?.logo ? 
                                        `<img src="${verification.Institution.logo}" alt="${verification.Institution.name}" class="rounded" style="width: 50px; height: 50px; object-fit: cover;">` :
                                        `<div class="bg-primary text-white rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                            <i class="fas fa-university fa-lg"></i>
                                        </div>`
                                    }
                                </div>
                                <div>
                                    <h4 class="mb-1">${verification.Institution?.name || verification.institutionName || 'Unknown Institution'}</h4>
                                    <p class="text-muted mb-0">Verification Request</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-${statusColor} fs-6">${verification.status}</span>
                            <p class="text-muted mt-2 mb-0">Created: ${formattedDate}</p>
                        </div>
                    </div>

                    <!-- Reference & ID -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="detail-item mb-3">
                                <label class="text-muted small">Reference Number</label>
                                <p class="mb-0 fw-bold">#${verification.referenceNumber || verification.id}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-item mb-3">
                                <label class="text-muted small">Verification ID</label>
                                <p class="mb-0">${verification.id || verification._id}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Student Information -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-user-graduate me-2"></i>Student Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="detail-item mb-3">
                                        <label class="text-muted small">Full Name</label>
                                        <p class="mb-0 fw-bold">${verification.firstName} ${verification.lastName}</p>
                                    </div>
                                    <div class="detail-item mb-3">
                                        <label class="text-muted small">Student ID</label>
                                        <p class="mb-0">${verification.studentId || verification.studentNumber || 'N/A'}</p>
                                    </div>
                                    <div class="detail-item mb-3">
                                        <label class="text-muted small">Date of Birth</label>
                                        <p class="mb-0">${verification.dateOfBirth ? formatDate(verification.dateOfBirth) : 'N/A'}</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="detail-item mb-3">
                                        <label class="text-muted small">Program/Course</label>
                                        <p class="mb-0">${verification.program || verification.course || 'N/A'}</p>
                                    </div>
                                    <div class="detail-item mb-3">
                                        <label class="text-muted small">Year of Graduation</label>
                                        <p class="mb-0">${verification.graduationYear || 'N/A'}</p>
                                    </div>
                                    <div class="detail-item mb-3">
                                        <label class="text-muted small">Classification</label>
                                        <p class="mb-0">${verification.classification || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Verification Details -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Verification Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="detail-item mb-3">
                                        <label class="text-muted small">Process Type</label>
                                        <p class="mb-0">${verification.process || 'Manual'}</p>
                                    </div>
                                    <div class="detail-item mb-3">
                                        <label class="text-muted small">Verification Score</label>
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                                <div class="progress-bar ${this.getScoreColor(verification.verificationScore || verification.score || 0)}" 
                                                     style="width: ${verification.verificationScore || verification.score || 0}%">
                                                </div>
                                            </div>
                                            <span class="fw-bold">${verification.verificationScore || verification.score || 0}%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="detail-item mb-3">
                                        <label class="text-muted small">Priority</label>
                                        <p class="mb-0">
                                            <span class="badge bg-${verification.priority === 'high' ? 'danger' : verification.priority === 'medium' ? 'warning' : 'info'}">
                                                ${verification.priority || 'normal'}
                                            </span>
                                        </p>
                                    </div>
                                    <div class="detail-item mb-3">
                                        <label class="text-muted small">Fee</label>
                                        <p class="mb-0 fw-bold text-success">$${verification.fee || verification.amount || '0.00'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline (if available) -->
                    ${verification.verificationStatuses && verification.verificationStatuses.length > 0 ? `
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-history me-2"></i>Verification Timeline</h6>
                        </div>
                        <div class="card-body">
                            <div class="timeline">
                                ${verification.verificationStatuses.map((status, index) => `
                                    <div class="timeline-item ${index === verification.verificationStatuses.length - 1 ? 'current' : ''}">
                                        <div class="timeline-marker"></div>
                                        <div class="timeline-content">
                                            <h6 class="mb-1">${status.status}</h6>
                                            <p class="text-muted mb-1 small">${status.message || 'Status updated'}</p>
                                            <small class="text-muted">${formatDate(status.createdAt)} ${formatTime(status.createdAt)}</small>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Documents (if available) -->
                    ${verification.documents && verification.documents.length > 0 ? `
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-paperclip me-2"></i>Attached Documents</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                ${verification.documents.map(doc => `
                                    <div class="col-md-4 mb-3">
                                        <div class="card document-card">
                                            <div class="card-body text-center">
                                                <i class="fas fa-file-pdf fa-2x text-danger mb-2"></i>
                                                <p class="mb-1 small">${doc.type || 'Document'}</p>
                                                <button class="btn btn-sm btn-outline-primary" onclick="downloadDocument('${doc.url}')">
                                                    <i class="fas fa-download me-1"></i>Download
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Notes (if available) -->
                    ${verification.notes ? `
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-sticky-note me-2"></i>Additional Notes</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">${verification.notes}</p>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            // Add action buttons to modal footer
            const modalFooter = modal.querySelector('.modal-footer');
            if (modalFooter) {
                modalFooter.innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="VerificationsService.downloadReport('${verification.id || verification._id}')">
                        <i class="fas fa-download me-2"></i>Download Report
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="VerificationsService.shareVerification('${verification.id || verification._id}')">
                        <i class="fas fa-share me-2"></i>Share
                    </button>
                `;
            }
        },

        createVerificationDetailsModal() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'verificationDetailsModal';
            modal.tabIndex = -1;
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-file-alt me-2"></i>Verification Details
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Content will be loaded here -->
                        </div>
                        <div class="modal-footer">
                            <!-- Action buttons will be loaded here -->
                        </div>
                    </div>
                </div>
            `;
            return modal;
        },

        getScoreColor(score) {
            if (score >= 90) return 'bg-success';
            if (score >= 70) return 'bg-warning';
            return 'bg-danger';
        },

        getStatusColor(status) {
            const statusMap = {
                'pending': 'warning',
                'pending_assignment': 'warning',
                'processing': 'info',
                'completed': 'success',
                'failed': 'danger',
                'cancelled': 'secondary'
            };
            return statusMap[status?.toLowerCase()] || 'secondary';
        },

        async downloadReport(verificationId) {
            try {
                const token = AuthService.getToken();
                if (!token) {
                    AuthService.redirectToLogin();
                    return;
                }

                showToast('info', 'Generating report...', true);

                const response = await fetch(`/reports/verifications/${verificationId}/pdf`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/pdf'
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `verification-report-${verificationId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showToast('success', 'Report downloaded successfully!');
                } else {
                    throw new Error('Failed to download report');
                }
            } catch (error) {
                console.error('Download error:', error);
                showToast('error', 'Failed to download report');
            }
        },

        async resendVerification(verificationId) {
            try {
                const token = AuthService.getToken();
                if (!token) {
                    AuthService.redirectToLogin();
                    return;
                }

                if (!confirm('Are you sure you want to resend this verification request?')) {
                    return;
                }

                showToast('info', 'Resending verification...', true);

                const response = await fetch(`/api/verifications/${verificationId}/resend`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showToast('success', 'Verification request resent successfully!');
                    } else {
                        throw new Error(data.message || 'Failed to resend verification');
                    }
                } else {
                    throw new Error('Failed to resend verification');
                }
            } catch (error) {
                console.error('Resend error:', error);
                showToast('error', error.message || 'Failed to resend verification');
            }
        },

        async shareVerification(verificationId) {
            try {
                const token = AuthService.getToken();
                const response = await fetch(`/api/verifications/${verificationId}/share`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const shareUrl = data.shareUrl || data.url;

                    if (navigator.share) {
                        await navigator.share({
                            title: 'Verification Report',
                            text: 'Check out this verification report',
                            url: shareUrl
                        });
                        showToast('success', 'Shared successfully!');
                    } else {
                        await navigator.clipboard.writeText(shareUrl);
                        showToast('success', 'Link copied to clipboard!');
                    }
                } else {
                    throw new Error('Failed to get share link');
                }
            } catch (error) {
                console.error('Share error:', error);
                showToast('error', 'Failed to share verification');
            }
        },

        async deleteVerification(verificationId) { 
            try {
                if (!confirm('Are you sure you want to delete this verification? This action cannot be undone.')) {
                    return;
                }

                const token = AuthService.getToken();
                const response = await fetch(`/api/verifications/${verificationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showToast('success', 'Verification deleted successfully!');
                        this.loadVerifications(this.currentPage);
                    } else {
                        throw new Error(data.message || 'Failed to delete verification');
                    }
                } else {
                    throw new Error('Failed to delete verification');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showToast('error', error.message || 'Failed to delete verification');
            }
        },

        updateStats(data) {
            const verifications = data.verifications || data.data || [];
            const stats = countVerificationStatus(verifications);
            
            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('completedCount').textContent = stats.completed;
            document.getElementById('processingCount').textContent = stats.processing;
            document.getElementById('failedCount').textContent = stats.pending;

            // Update progress bars
            const total = stats.total || 1;
            document.getElementById('completedProgress').style.width = `${(stats.completed / total) * 100}%`;
            document.getElementById('processingProgress').style.width = `${(stats.processing / total) * 100}%`;
            document.getElementById('failedProgress').style.width = `${(stats.pending / total) * 100}%`;
        },

        updatePagination(total, currentPage) {
            this.totalItems = total;
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(total / this.pageSize);

            // Update showing counts
            const start = ((currentPage - 1) * this.pageSize) + 1;
            const end = Math.min(currentPage * this.pageSize, total);

            document.getElementById('startCount').textContent = start;
            document.getElementById('endCount').textContent = end;
            document.getElementById('totalItems').textContent = total;
            document.getElementById('showingCount').textContent = `Showing ${end - start + 1} items`;

            // Generate pagination
            if (!pagination) return;
            
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">
                <i class="fas fa-chevron-left"></i>
            </a>`;
            pagination.appendChild(prevLi);

            // Page numbers
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = startPage + maxVisible - 1;

            if (endPage > totalPages) {
                endPage = totalPages;
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                pagination.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">
                <i class="fas fa-chevron-right"></i>
            </a>`;
            pagination.appendChild(nextLi);
        },

        async searchVerifications(query) {
            this.currentSearch = query;
            this.currentPage = 1;
            await this.loadVerifications(1);
        },

        async applyFilter(filter) {
            this.currentFilter = filter;
            this.currentPage = 1;
            await this.loadVerifications(1);
        },

        async exportSelected() {
            if (this.selectedItems.size === 0) {
                showToast('warning', 'Please select items to export');
                return;
            }

            try {
                const token = AuthService.getToken();
                const response = await fetch('/verification/export', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ids: Array.from(this.selectedItems)
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `verifications-export-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showToast('success', 'Export completed successfully');
                }
            } catch (error) {
                console.error('Export error:', error);
                showToast('error', 'Failed to export');
            }
        }
    };

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function () {
        // Load initial data
        VerificationsService.loadVerifications();

        // New Verification Button
        document.getElementById('newVerificationBtn')?.addEventListener('click', () => {
            const modal = new bootstrap.Modal(document.getElementById('newVerificationModal'));
            modal.show();
        });

        // Search functionality
        const searchInput = document.getElementById('searchInput');
        let searchTimeout;

        searchInput?.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                VerificationsService.searchVerifications(e.target.value);
            }, 500);
        });

        document.getElementById('clearSearch')?.addEventListener('click', () => {
            if (searchInput) searchInput.value = '';
            VerificationsService.searchVerifications('');
        });

        // Filter dropdown
        document.querySelectorAll('[data-filter]').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const filter = e.target.getAttribute('data-filter');
                VerificationsService.applyFilter(filter);
                
                // Update filter button text
                const filterBtn = document.getElementById('filterBtn');
                if (filterBtn) {
                    filterBtn.innerHTML = `<i class="fas fa-filter me-2"></i>${e.target.textContent}`;
                }
            });
        });

        // Pagination
        document.getElementById('pagination')?.addEventListener('click', (e) => {
            e.preventDefault();
            const target = e.target.closest('a');
            if (target && target.hasAttribute('data-page')) {
                const page = parseInt(target.getAttribute('data-page'));
                if (page && !isNaN(page)) {
                    VerificationsService.loadVerifications(page);
                }
            }
        });

        // Select All
        document.getElementById('selectAll')?.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            document.querySelectorAll('.row-select').forEach(checkbox => {
                checkbox.checked = isChecked;
                const id = checkbox.value;
                if (isChecked) {
                    VerificationsService.selectedItems.add(id);
                } else {
                    VerificationsService.selectedItems.delete(id);
                }
            });
        });

        // Bulk Actions
        document.getElementById('applyBulkAction')?.addEventListener('click', () => {
            const action = document.getElementById('bulkActionSelect')?.value;

            switch (action) {
                case 'export':
                    VerificationsService.exportSelected();
                    break;
                case 'resend':
                    if (VerificationsService.selectedItems.size === 0) {
                        showToast('warning', 'Please select items to resend');
                        return;
                    }
                    if (confirm(`Resend ${VerificationsService.selectedItems.size} verification(s)?`)) {
                        // Implement bulk resend
                        VerificationsService.selectedItems.forEach(id => {
                            VerificationsService.resendVerification(id);
                        });
                    }
                    break;
                case 'archive':
                    // Implement archive logic
                    showToast('info', 'Archive feature coming soon');
                    break;
                case 'delete':
                    if (VerificationsService.selectedItems.size === 0) {
                        showToast('warning', 'Please select items to delete');
                        return;
                    }
                    if (confirm(`Delete ${VerificationsService.selectedItems.size} verification(s)? This cannot be undone.`)) {
                        VerificationsService.selectedItems.forEach(id => {
                            VerificationsService.deleteVerification(id);
                        });
                        VerificationsService.selectedItems.clear();
                    }
                    break;
                default:
                    showToast('warning', 'Please select an action');
            }
        });

        // Refresh button
        document.getElementById('refreshBtn')?.addEventListener('click', () => {
            VerificationsService.loadVerifications(VerificationsService.currentPage);
            showToast('info', 'Refreshing data...');
        });

        // Create first verification button
        document.addEventListener('click', (e) => {
            if (e.target.id === 'createFirstVerification') {
                window.location.href = '/api/institutions-page';
            }
        });
    });

    // Helper functions
    function countVerificationStatus(verifications) {
        const counts = {
            total: verifications.length,
            pending: 0,
            processing: 0,
            completed: 0,
            failed: 0
        };

        verifications.forEach(v => {
            const status = v.status?.toLowerCase();
            if (status === 'pending' || status === 'pending_assignment') {
                counts.pending++;
            } else if (status === 'processing') {
                counts.processing++;
            } else if (status === 'completed') {
                counts.completed++;
            } else if (status === 'failed') {
                counts.failed++;
            }
        });

        return counts;
    }

    function showToast(type, message, loading = false) {
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }

        const toastId = `toast-${Date.now()}`;
        const toast = document.createElement('div');
        toast.className = `toast ${loading ? 'align-items-center' : ''}`;
        toast.id = toastId;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');

        const bgColor = type === 'success' ? 'bg-success' : 
                       type === 'error' ? 'bg-danger' : 
                       type === 'warning' ? 'bg-warning' : 'bg-info';

        toast.innerHTML = `
            <div class="toast-header ${bgColor} text-white">
                <strong class="me-auto">
                    ${type === 'success' ? 'Success' : 
                      type === 'error' ? 'Error' : 
                      type === 'warning' ? 'Warning' : 'Info'}
                </strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${loading ? `
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        <span>${message}</span>
                    </div>
                ` : message}
            </div>
        `;

        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, { autohide: !loading, delay: loading ? 10000 : 3000 });
        bsToast.show();

        // Remove toast after hiding
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });

        return bsToast;
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    function formatTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Helper function to download documents
    function downloadDocument(url) {
        if (!url) {
            showToast('error', 'No document URL available');
            return;
        }
        
        const a = document.createElement('a');
        a.href = url;
        a.download = url.split('/').pop() || 'document.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // Auth service mock if not defined
    window.AuthService = window.AuthService || {
        getToken: function() {
            return localStorage.getItem('token') || sessionStorage.getItem('token');
        },
        redirectToLogin: function() {
            window.location.href = '/auth/login';
        }
    };

    // Add CSS for timeline
    const style = document.createElement('style');
    style.textContent = `
        .timeline {
            position: relative;
            padding-left: 2rem;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #dee2e6;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .timeline-item.current .timeline-marker {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        
        .timeline-marker {
            position: absolute;
            left: -2rem;
            top: 0.25rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background-color: #6c757d;
            border: 2px solid white;
        }
        
        .timeline-content {
            padding-left: 0.5rem;
        }
        
        .document-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .document-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .detail-item label {
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
            display: block;
            color: #6c757d;
        }
        
        .detail-item p {
            margin: 0;
            font-size: 0.9rem;
        }
    `;
    document.head.appendChild(style);
</script>

<style>
    .viewall-verifications-page {
        padding: 1.5rem;
        background: #f8f9fa;
        min-height: 100vh;
    }

    .page-header {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .stat-card {
        border: none;
        border-radius: 12px;
        transition: transform 0.2s;
        cursor: pointer;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-card .progress {
        background-color: rgba(255, 255, 255, 0.3);
    }

    .status-badge {
        padding: 0.35rem 0.75rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-pending {
        background: #fef3c7;
        color: #f59e0b;
    }

    .status-processing {
        background: #dbeafe;
        color: #3b82f6;
    }

    .status-completed {
        background: #d1fae5;
        color: #10b981;
    }

    .status-failed {
        background: #fee2e2;
        color: #dc2626;
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }

    .institution-logo-sm {
        width: 30px;
        height: 30px;
        object-fit: contain;
        border-radius: 6px;
        background: white;
        padding: 2px;
        border: 1px solid #dee2e6;
    }

    .score-display {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .score-display .progress {
        background-color: #e9ecef;
    }

    .verification-row:hover {
        background-color: #f8f9fa;
    }

    .table th {
        font-weight: 600;
        color: #495057;
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        padding: 0.75rem;
    }

    .table td {
        padding: 0.75rem;
        vertical-align: middle;
    }

    .pagination .page-item.active .page-link {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    @media (max-width: 768px) {
        .viewall-verifications-page {
            padding: 1rem;
        }

        .stat-card .d-flex {
            flex-direction: column;
            text-align: center;
        }

        .stat-card i {
            margin-top: 10px;
        }

        .table-responsive {
            font-size: 0.875rem;
        }

        .action-buttons .btn-group {
            width: 100%;
            flex-wrap: wrap;
        }
    }
</style>