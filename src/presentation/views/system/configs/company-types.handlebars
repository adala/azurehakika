<div class="container-fluid py-4">
    <div class="content-header">
        <h1 class="h3">
            <i class="fas fa-building"></i> Company Types Management
        </h1>
        <p class="text-muted">Manage company types for verification purposes</p>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Company Types</h5>
                    <button class="btn btn-primary btn-sm" id="addCompanyTypeBtn">
                        <i class="fas fa-plus"></i> Add Company Type
                    </button>
                </div>
                <div class="card-body">
                    <div id="companyTypesList">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Company Type Modal -->
<div class="modal fade" id="companyTypeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="companyTypeModalTitle">Add Company Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="companyTypeForm">
                    <div class="mb-3">
                        <label for="typeName" class="form-label">Company Type Name</label>
                        <input type="text" class="form-control" id="typeName" required>
                    </div>
                    <div class="mb-3">
                        <label for="typeDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="typeDescription" rows="3"></textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="typeIsActive">
                        <label class="form-check-label" for="typeIsActive">
                            Active
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCompanyTypeBtn">Save Company Type</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadCompanyTypes();

        document.getElementById('addCompanyTypeBtn').addEventListener('click', function () {
            showCompanyTypeModal();
        });

        document.getElementById('saveCompanyTypeBtn').addEventListener('click', saveCompanyType);
    });

    async function loadCompanyTypes() {
        try {
            const response = await axios.get('/admin/company-types');
            const companyTypes = response.data.data;

            const companyTypesList = document.getElementById('companyTypesList');

            if (companyTypes.length === 0) {
                companyTypesList.innerHTML = '<div class="text-center py-4"><p class="text-muted">No company types found</p></div>';
                return;
            }

            let html = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

            companyTypes.forEach(type => {
                html += `
                <tr>
                    <td>${type.value}</td>
                    <td>${type.name || '-'}</td>
                    <td>
                        <span class="badge ${type.is_active ? 'bg-success' : 'bg-secondary'}">
                            ${type.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editCompanyType('${type.id}', '${type.name}', '${type.description || ''}', ${type.is_active})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCompanyType('${type.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            });

            html += `
                    </tbody>
                </table>
            </div>
        `;

            companyTypesList.innerHTML = html;
        } catch (error) {
            console.error('Error loading company types:', error);
            document.getElementById('companyTypesList').innerHTML = '<div class="alert alert-danger">Error loading company types</div>';
        }
    }

    function showCompanyTypeModal(type = null) {
        const modal = new bootstrap.Modal(document.getElementById('companyTypeModal'));
        const form = document.getElementById('companyTypeForm');
        const title = document.getElementById('companyTypeModalTitle');

        form.reset();

        if (type) {
            title.textContent = 'Edit Company Type';
            document.getElementById('typeName').value = type.name;
            document.getElementById('typeDescription').value = type.description || '';
            document.getElementById('typeIsActive').checked = type.isActive;
            form.dataset.editId = type.id;
        } else {
            title.textContent = 'Add Company Type';
            delete form.dataset.editId;
        }

        modal.show();
    }

    async function saveCompanyType() {
        const form = document.getElementById('companyTypeForm');
        const name = document.getElementById('typeName').value;
        const description = document.getElementById('typeDescription').value;
        const isActive = document.getElementById('typeIsActive').checked;

        if (!name) {
            alert('Please fill in the company type name');
            return;
        }

        try {
            const companyTypesResponse = await axios.get('/api/config/company-types');
            let updatedCompanyTypes = companyTypesResponse.data.data;

            if (form.dataset.editId) {
                // Update existing type
                updatedCompanyTypes = updatedCompanyTypes.map(type =>
                    type.id === form.dataset.editId
                        ? { ...type, name, description, is_active: isActive }
                        : type
                );
            } else {
                // Add new type
                const newType = {
                    id: Date.now().toString(),
                    name,
                    description, 
                    is_active: isActive
                };
                updatedCompanyTypes.push(newType);
            }

            await axios.put('/api/config/company-types', { companyTypes: updatedCompanyTypes });

            bootstrap.Modal.getInstance(document.getElementById('companyTypeModal')).hide();
            loadCompanyTypes();

        } catch (error) {
            console.error('Error saving company type:', error);
            alert('Error saving company type');
        }
    }

    function editCompanyType(id, name, description, isActive) {
        showCompanyTypeModal({ id, name, description, isActive });
    }

    async function deleteCompanyType(id) {
        if (!confirm('Are you sure you want to delete this company type?')) {
            return;
        }

        try {
            const companyTypesResponse = await axios.get('/api/config/company-types');
            const updatedCompanyTypes = companyTypesResponse.data.data.filter(type => type.id !== id);

            await axios.put('/api/config/company-types', { companyTypes: updatedCompanyTypes });
            loadCompanyTypes();

        } catch (error) {
            console.error('Error deleting company type:', error);
            alert('Error deleting company type');
        }
    }
</script>