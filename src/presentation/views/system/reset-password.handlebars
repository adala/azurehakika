<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <div class="card shadow">
            <div class="card-header bg-primary text-white text-center py-4">
                <i class="fas fa-lock fa-3x mb-3"></i>
                <h2 class="mb-0">Set New Password</h2>
                <p class="mb-0 opacity-75">Create a new password for your account</p>
            </div>
            <div class="card-body p-5">
                <div id="alertContainer"></div>

                <form id="resetPasswordForm">
                    <input type="hidden" id="resetToken" name="token" value="{{token}}">
                    
                    <div class="mb-4">
                        <label for="password" class="form-label">New Password</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="password" name="password" 
                                   placeholder="Enter new password" required minlength="8">
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            Password must be at least 8 characters long
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" 
                                   placeholder="Confirm new password" required>
                            <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Make sure your new password is strong and different from previous passwords.
                    </div>

                    <button type="submit" class="btn btn-primary w-100 py-3" id="resetPasswordBtn">
                        <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
                        Reset Password
                    </button>
                </form>

                <div class="text-center mt-4">
                    <p class="mb-0">
                        <a href="/auth/login" class="text-decoration-none">
                            <i class="fas fa-arrow-left me-2"></i>Back to Login
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title text-success">
                    <i class="fas fa-check-circle me-2"></i>Password Reset Successful
                </h5>
            </div>
            <div class="modal-body text-center py-4">
                <i class="fas fa-check-circle text-success display-1 mb-3"></i>
                <h4 class="mb-3">Password Updated!</h4>
                <p class="text-muted">Your password has been reset successfully. You can now log in with your new password.</p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <a href="/auth/login" class="btn btn-primary px-4">Go to Login</a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const resetPasswordForm = document.getElementById('resetPasswordForm');
    const resetPasswordBtn = document.getElementById('resetPasswordBtn');
    const togglePasswordBtn = document.getElementById('togglePassword');
    const toggleConfirmPasswordBtn = document.getElementById('toggleConfirmPassword');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');

    // Toggle password visibility
    togglePasswordBtn.addEventListener('click', function() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
    });

    toggleConfirmPasswordBtn.addEventListener('click', function() {
        const type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        confirmPasswordInput.setAttribute('type', type);
        this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
    });

    // Form submission
    resetPasswordForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        const token = document.getElementById('resetToken').value;

        if (!password || !confirmPassword) {
            showAlert('Please fill in all fields', 'danger');
            return;
        }

        if (password !== confirmPassword) {
            showAlert('Passwords do not match', 'danger');
            return;
        }

        if (password.length < 8) {
            showAlert('Password must be at least 8 characters long', 'danger');
            return;
        }

        await resetPassword({ token, password, confirmPassword });
    });

    async function resetPassword(payload) {
        const originalContent = resetPasswordBtn.innerHTML;
        
        try {
            // Show loading state
            resetPasswordBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Resetting...';
            resetPasswordBtn.disabled = true;

            const response = await fetch('/auth/reset-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.success) {
                // Show success modal
                const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                successModal.show();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('Reset password error:', error);
            showAlert(error.message, 'danger');
        } finally {
            // Reset button state
            resetPasswordBtn.innerHTML = originalContent;
            resetPasswordBtn.disabled = false;
        }
    }

    function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            <i class="fas fa-${type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.appendChild(alert);
    }

    // Check if token is present
    const token = document.getElementById('resetToken').value;
    if (!token) {
        showAlert('Invalid reset link. Please request a new password reset.', 'danger');
        resetPasswordBtn.disabled = true;
    }
});
</script>

<style>
.card {
    border: none;
    border-radius: 15px;
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
}

.btn-primary {
    background: linear-gradient(45deg, #007bff, #0056b3);
    border: none;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
}

.form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.alert {
    border: none;
    border-radius: 10px;
}
</style>