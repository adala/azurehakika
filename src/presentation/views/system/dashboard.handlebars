<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-2">
                <i class="fas fa-tachometer-alt me-2 text-primary"></i>
                {{#if (eq user.role 'admin')}}System Administration Dashboard
                {{else if (eq user.role 'supervisor')}}Supervisor Dashboard
                {{else}}Worker Dashboard{{/if}}
            </h1>
            <p class="text-muted mb-0">
                <i class="fas fa-calendar-alt me-1"></i>
                {{formatDate currentDate}} â€¢ Welcome back, {{user.firstName}}!
            </p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
            <button class="btn btn-primary btn-sm" onclick="generateReport()">
                <i class="fas fa-file-export me-1"></i>Export Report
            </button>
        </div>
    </div>

    <!-- Stats Overview Cards -->
    <div class="row mb-4">
        {{#if (eq user.role 'admin')}}
            <!-- Admin Stats -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stat-card border-start border-primary border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2 text-muted">Total Users</h6>
                                <h3 class="card-title mb-0">{{counts.totalUsers}}</h3>
                                <small class="text-success">
                                    <i class="fas fa-arrow-up me-1"></i>{{counts.activeUsers}} active
                                </small>
                            </div>
                            <div class="stat-icon bg-primary">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stat-card border-start border-success border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2 text-muted">Institutions</h6>
                                <h3 class="card-title mb-0">{{counts.totalInstitutions}}</h3>
                                <small class="text-muted">
                                    <i class="fas fa-database me-1"></i>Configured
                                </small>
                            </div>
                            <div class="stat-icon bg-success">
                                <i class="fas fa-university"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stat-card border-start border-warning border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2 text-muted">Pending Verifications</h6>
                                <h3 class="card-title mb-0">{{counts.pendingVerifications}}</h3>
                                <small class="text-warning">
                                    <i class="fas fa-clock me-1"></i>Awaiting processing
                                </small>
                            </div>
                            <div class="stat-icon bg-warning">
                                <i class="fas fa-tasks"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stat-card border-start border-info border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2 text-muted">System Uptime</h6>
                                <h3 class="card-title mb-0">{{overview.successRate}}%</h3>
                                <small class="text-info">
                                    <i class="fas fa-check-circle me-1"></i>Success rate
                                </small>
                            </div>
                            <div class="stat-icon bg-info">
                                <i class="fas fa-server"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        {{else if (eq user.role 'supervisor')}}
            <!-- Supervisor Stats -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stat-card border-start border-primary border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2 text-muted">Assigned Workers</h6>
                                <h3 class="card-title mb-0">{{counts.assignedWorkers}}</h3>
                                <small class="text-muted">
                                    <i class="fas fa-user-check me-1"></i>Active team
                                </small>
                            </div>
                            <div class="stat-icon bg-primary">
                                <i class="fas fa-user-friends"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stat-card border-start border-warning border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2 text-muted">Pending Assignments</h6>
                                <h3 class="card-title mb-0">{{counts.pendingAssignments}}</h3>
                                <small class="text-warning">
                                    <i class="fas fa-exclamation-circle me-1"></i>To assign
                                </small>
                            </div>
                            <div class="stat-icon bg-warning">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stat-card border-start border-success border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2 text-muted">Completed</h6>
                                <h3 class="card-title mb-0">{{counts.completedAssignments}}</h3>
                                <small class="text-success">
                                    <i class="fas fa-check me-1"></i>Verified
                                </small>
                            </div>
                            <div class="stat-icon bg-success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stat-card border-start border-danger border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2 text-muted">Team Productivity</h6>
                                <h3 class="card-title mb-0">{{counts.teamProductivity}}%</h3>
                                <small class="{{#if (gt counts.teamProductivity 80)}}text-success{{else}}text-danger{{/if}}">
                                    <i class="fas fa-chart-line me-1"></i>Overall
                                </small>
                            </div>
                            <div class="stat-icon bg-danger">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        {{else}}
            <!-- Worker Stats -->
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stat-card border-start border-warning border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2 text-muted">Pending Tasks</h6>
                                <h3 class="card-title mb-0">{{counts.pendingTasks}}</h3>
                                <small class="text-warning">
                                    <i class="fas fa-clock me-1"></i>To complete
                                </small>
                            </div>
                            <div class="stat-icon bg-warning">
                                <i class="fas fa-tasks"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stat-card border-start border-success border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2 text-muted">Completed Tasks</h6>
                                <h3 class="card-title mb-0">{{counts.completedTasks}}</h3>
                                <small class="text-success">
                                    <i class="fas fa-check me-1"></i>Processed
                                </small>
                            </div>
                            <div class="stat-icon bg-success">
                                <i class="fas fa-check-double"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stat-card border-start border-primary border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2 text-muted">Accuracy Rate</h6>
                                <h3 class="card-title mb-0">{{counts.accuracyRate}}%</h3>
                                <small class="{{#if (gt counts.accuracyRate 90)}}text-success{{else}}text-warning{{/if}}">
                                    <i class="fas fa-bullseye me-1"></i>Score
                                </small>
                            </div>
                            <div class="stat-icon bg-primary">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stat-card border-start border-info border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2 text-muted">Avg. Time</h6>
                                <h3 class="card-title mb-0">{{counts.avgCompletionTime}}m</h3>
                                <small class="text-info">
                                    <i class="fas fa-hourglass me-1"></i>Per task
                                </small>
                            </div>
                            <div class="stat-icon bg-info">
                                <i class="fas fa-stopwatch"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {{/if}}
    </div>

    <!-- Charts and Visualizations -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>Performance Overview
                    </h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary active" onclick="changeChartRange('week')">Week</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="changeChartRange('month')">Month</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="changeChartRange('quarter')">Quarter</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="performanceChart" style="height: 300px;">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading chart...</span>
                            </div>
                            <p class="mt-3 text-muted">Loading performance data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <div id="distributionChart" style="height: 250px;">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading chart...</span>
                            </div>
                            <p class="mt-3 text-muted">Loading distribution data...</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        {{#if (eq user.role 'admin')}}
                            {{#each charts.userRoles}}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>{{role}}</span>
                                <span class="badge bg-light text-dark">{{count}}</span>
                            </div>
                            {{/each}}
                        {{else if (eq user.role 'supervisor')}}
                            {{#each charts.priorityDistribution}}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>{{priority}}</span>
                                <span class="badge bg-light text-dark">{{count}}</span>
                            </div>
                            {{/each}}
                        {{else}}
                            {{#each charts.taskTypeDistribution}}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>{{type}}</span>
                                <span class="badge bg-light text-dark">{{count}}</span>
                            </div>
                            {{/each}}
                        {{/if}}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions & Recent Activity -->
    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {{#if (eq user.role 'admin')}}
                            <div class="col-md-6">
                                <a href="/system/users" class="btn btn-outline-primary w-100 text-start">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="fas fa-user-plus fa-2x"></i>
                                        </div>
                                        <div>
                                            <strong>Manage Users</strong>
                                            <small class="d-block text-muted">Add/Edit system users</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="/admin/institution" class="btn btn-outline-success w-100 text-start">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="fas fa-university fa-2x"></i>
                                        </div>
                                        <div>
                                            <strong>Institutions</strong>
                                            <small class="d-block text-muted">Configure institutions</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="/system/assignments" class="btn btn-outline-warning w-100 text-start">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="fas fa-tasks fa-2x"></i>
                                        </div>
                                        <div>
                                            <strong>Assign Tasks</strong>
                                            <small class="d-block text-muted">Manage verifications</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="/system/settings" class="btn btn-outline-info w-100 text-start">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="fas fa-cogs fa-2x"></i>
                                        </div>
                                        <div>
                                            <strong>Settings</strong>
                                            <small class="d-block text-muted">System configuration</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        {{else if (eq user.role 'supervisor')}}
                            <div class="col-md-6">
                                <a href="/system/assignments" class="btn btn-outline-primary w-100 text-start">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="fas fa-tasks fa-2x"></i>
                                        </div>
                                        <div>
                                            <strong>Assign Tasks</strong>
                                            <small class="d-block text-muted">Assign to workers</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="/system/monitoring" class="btn btn-outline-success w-100 text-start">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="fas fa-eye fa-2x"></i>
                                        </div>
                                        <div>
                                            <strong>Monitor Progress</strong>
                                            <small class="d-block text-muted">Track team activity</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="/system/reports" class="btn btn-outline-warning w-100 text-start">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="fas fa-chart-bar fa-2x"></i>
                                        </div>
                                        <div>
                                            <strong>Reports</strong>
                                            <small class="d-block text-muted">Generate reports</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="/system/profile" class="btn btn-outline-info w-100 text-start">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="fas fa-user-cog fa-2x"></i>
                                        </div>
                                        <div>
                                            <strong>Team Settings</strong>
                                            <small class="d-block text-muted">Manage team</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        {{else}}
                            <div class="col-md-6">
                                <a href="/system/my-tasks" class="btn btn-outline-primary w-100 text-start">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="fas fa-clipboard-list fa-2x"></i>
                                        </div>
                                        <div>
                                            <strong>My Tasks</strong>
                                            <small class="d-block text-muted">View assigned tasks</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="/system/completed-tasks" class="btn btn-outline-success w-100 text-start">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="fas fa-check-circle fa-2x"></i>
                                        </div>
                                        <div>
                                            <strong>Completed</strong>
                                            <small class="d-block text-muted">View completed work</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="/system/profile" class="btn btn-outline-warning w-100 text-start">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="fas fa-user-edit fa-2x"></i>
                                        </div>
                                        <div>
                                            <strong>My Profile</strong>
                                            <small class="d-block text-muted">Update information</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-info w-100 text-start" onclick="requestSupport()">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="fas fa-question-circle fa-2x"></i>
                                        </div>
                                        <div>
                                            <strong>Get Help</strong>
                                            <small class="d-block text-muted">Contact supervisor</small>
                                        </div>
                                    </div>
                                </button>
                            </div>
                        {{/if}}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>Recent Activity
                    </h5>
                    <a href="/system/activity" class="btn btn-sm btn-outline-secondary">View All</a>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {{#if recentActivity.length}}
                            {{#each recentActivity}}
                            <div class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <div class="d-flex align-items-start">
                                        <div class="me-3">
                                            <i class="fas fa-{{getActivityIcon type}} text-{{getActivityColor type}}"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1">{{message}}</h6>
                                            <small class="text-muted">{{description}}</small>
                                        </div>
                                    </div>
                                    <small class="text-muted">{{formatTimeAgo timestamp}}</small>
                                </div>
                            </div>
                            {{/each}}
                        {{else}}
                            <div class="text-center py-5">
                                <i class="fas fa-history fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">No recent activity</h6>
                                <p class="small text-muted">Your activity will appear here</p>
                            </div>
                        {{/if}}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">System Status</h6>
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="spinner-grow spinner-grow-sm text-success" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <div>
                                    <small class="text-muted">All systems operational</small>
                                    <div class="progress" style="width: 200px; height: 5px;">
                                        <div class="progress-bar bg-success" style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-end">
                            <small class="text-muted d-block">Last updated: {{formatDate currentDate "HH:mm:ss"}}</small>
                            <small class="text-muted">Uptime: {{overview.systemUptime}}%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart Libraries -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
.dashboard-container {
    padding: 0.5rem;
}

.stat-card {
    border: none;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    transition: transform 0.2s, box-shadow 0.2s;
    height: 100%;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
}

.bg-primary { background-color: #4361ee !important; }
.bg-success { background-color: #06d6a0 !important; }
.bg-warning { background-color: #ffd166 !important; }
.bg-info { background-color: #118ab2 !important; }
.bg-danger { background-color: #ef476f !important; }

.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    margin-bottom: 1.5rem;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    border-radius: 12px 12px 0 0 !important;
    padding: 1rem 1.25rem;
}

.card-title {
    font-weight: 600;
    color: #2d3748;
}

.list-group-item {
    border: none;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #f1f3f5;
}

.list-group-item:last-child {
    border-bottom: none;
}

.list-group-item:hover {
    background-color: #f8f9fa;
}

.progress {
    background-color: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
}

.progress-bar {
    border-radius: 10px;
}

.btn-outline-primary {
    color: #4361ee;
    border-color: #4361ee;
}

.btn-outline-primary:hover {
    background-color: #4361ee;
    border-color: #4361ee;
}

.btn-outline-success {
    color: #06d6a0;
    border-color: #06d6a0;
}

.btn-outline-success:hover {
    background-color: #06d6a0;
    border-color: #06d6a0;
    color: white;
}

.btn-outline-warning {
    color: #ffd166;
    border-color: #ffd166;
}

.btn-outline-warning:hover {
    background-color: #ffd166;
    border-color: #ffd166;
    color: #212529;
}

.btn-outline-info {
    color: #118ab2;
    border-color: #118ab2;
}

.btn-outline-info:hover {
    background-color: #118ab2;
    border-color: #118ab2;
    color: white;
}

.text-primary { color: #4361ee !important; }
.text-success { color: #06d6a0 !important; }
.text-warning { color: #ffd166 !important; }
.text-info { color: #118ab2 !important; }
.text-danger { color: #ef476f !important; }

@media (max-width: 768px) {
    .dashboard-container {
        padding: 0.25rem;
    }
    
    .stat-card {
        margin-bottom: 1rem;
    }
    
    h1.h2 {
        font-size: 1.5rem;
    }
}
</style>

<script>
// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    startAutoRefresh();
    
    // Check for notifications
    if ({{notifications.length}} > 0) {
        showNotificationToast();
    }
});

function initializeCharts() {
    // Performance Chart
    const performanceOptions = {
        series: [{
            name: 'Performance',
            data: {{#if (eq user.role 'admin')}}
                {{#if charts.monthlyTrend}}
                    [{{#each charts.monthlyTrend}}{{count}}{{#unless @last}},{{/unless}}{{/each}}]
                {{else}}[0,0,0,0,0,0]{{/if}}
            {{else if (eq user.role 'supervisor')}}
                {{#if charts.weeklyCompletion}}
                    [{{#each charts.weeklyCompletion}}{{rate}}{{#unless @last}},{{/unless}}{{/each}}]
                {{else}}[0,0,0,0]{{/if}}
            {{else}}
                {{#if charts.performanceTrend}}
                    [{{#each charts.performanceTrend}}{{score}}{{#unless @last}},{{/unless}}{{/each}}]
                {{else}}[0,0,0,0,0]{{/if}}
            {{/if}}
        }],
        chart: {
            height: 300,
            type: 'line',
            zoom: {
                enabled: false
            },
            toolbar: {
                show: true,
                tools: {
                    download: true,
                    selection: false,
                    zoom: false,
                    zoomin: false,
                    zoomout: false,
                    pan: false,
                    reset: false
                }
            }
        },
        colors: ['#4361ee'],
        stroke: {
            width: 3,
            curve: 'smooth'
        },
        markers: {
            size: 5,
            colors: ['#4361ee'],
            strokeWidth: 0
        },
        xaxis: {
            categories: {{#if (eq user.role 'admin')}}
                {{#if charts.monthlyTrend}}
                    [{{#each charts.monthlyTrend}}"{{month}}"{{#unless @last}},{{/unless}}{{/each}}]
                {{else}}['Jan','Feb','Mar','Apr','May','Jun']{{/if}}
            {{else if (eq user.role 'supervisor')}}
                {{#if charts.weeklyCompletion}}
                    [{{#each charts.weeklyCompletion}}"Week {{@index}}"{{#unless @last}},{{/unless}}{{/each}}]
                {{else}}['Week 1','Week 2','Week 3','Week 4']{{/if}}
            {{else}}
                {{#if charts.performanceTrend}}
                    [{{#each charts.performanceTrend}}"{{date}}"{{#unless @last}},{{/unless}}{{/each}}]
                {{else}}['Day 1','Day 2','Day 3','Day 4','Day 5']{{/if}}
            {{/if}},
            labels: {
                style: {
                    colors: '#6c757d',
                    fontSize: '12px'
                }
            }
        },
        yaxis: {
            labels: {
                style: {
                    colors: '#6c757d',
                    fontSize: '12px'
                },
                formatter: function(value) {
                    return value + '{{#if (eq user.role 'admin')}}{{else if (eq user.role 'supervisor')}}%{{else}} pts{{/if}}';
                }
            }
        },
        grid: {
            borderColor: '#e9ecef',
            strokeDashArray: 5
        },
        tooltip: {
            theme: 'light',
            y: {
                formatter: function(value) {
                    return value + '{{#if (eq user.role 'admin')}} verifications{{else if (eq user.role 'supervisor')}}% completion{{else}} points{{/if}}';
                }
            }
        }
    };

    const performanceChart = new ApexCharts(document.querySelector("#performanceChart"), performanceOptions);
    performanceChart.render();

    // Distribution Chart
    const distributionOptions = {
        series: {{#if (eq user.role 'admin')}}
            {{#if charts.userRoles}}
                [{{#each charts.userRoles}}{{count}}{{#unless @last}},{{/unless}}{{/each}}]
            {{else}}[0,0,0]{{/if}}
        {{else if (eq user.role 'supervisor')}}
            {{#if charts.priorityDistribution}}
                [{{#each charts.priorityDistribution}}{{count}}{{#unless @last}},{{/unless}}{{/each}}]
            {{else}}[0,0,0,0]{{/if}}
        {{else}}
            {{#if charts.taskTypeDistribution}}
                [{{#each charts.taskTypeDistribution}}{{count}}{{#unless @last}},{{/unless}}{{/each}}]
            {{else}}[0,0,0]{{/if}}
        {{/if}},
        chart: {
            type: 'donut',
            height: 250
        },
        colors: ['#4361ee', '#06d6a0', '#ffd166', '#118ab2', '#ef476f'],
        labels: {{#if (eq user.role 'admin')}}
            {{#if charts.userRoles}}
                [{{#each charts.userRoles}}"{{role}}"{{#unless @last}},{{/unless}}{{/each}}]
            {{else}}['Admin','Supervisor','Worker']{{/if}}
        {{else if (eq user.role 'supervisor')}}
            {{#if charts.priorityDistribution}}
                [{{#each charts.priorityDistribution}}"{{priority}}"{{#unless @last}},{{/unless}}{{/each}}]
            {{else}}['Low','Medium','High','Urgent']{{/if}}
        {{else}}
            {{#if charts.taskTypeDistribution}}
                [{{#each charts.taskTypeDistribution}}"{{type}}"{{#unless @last}},{{/unless}}{{/each}}]
            {{else}}['API','Manual','Review']{{/if}}
        {{/if}},
        legend: {
            position: 'bottom',
            horizontalAlign: 'center'
        },
        plotOptions: {
            pie: {
                donut: {
                    size: '65%'
                }
            }
        },
        responsive: [{
            breakpoint: 480,
            options: {
                chart: {
                    height: 200
                },
                legend: {
                    position: 'bottom'
                }
            }
        }]
    };

    const distributionChart = new ApexCharts(document.querySelector("#distributionChart"), distributionOptions);
    distributionChart.render();
}

function changeChartRange(range) {
    const buttons = document.querySelectorAll('.btn-group .btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Here you would fetch new data based on the range
    // For now, we'll just show a message
    showToast('info', `Loading ${range} data...`);
    
    // Simulate API call
    setTimeout(() => {
        // In a real app, you would update the charts with new data
        // performanceChart.updateSeries([newData]);
        showToast('success', `${range.charAt(0).toUpperCase() + range.slice(1)} data loaded`);
    }, 1000);
}

function refreshDashboard() {
    const refreshBtn = event.target;
    const originalHtml = refreshBtn.innerHTML;
    
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
    
    // Simulate API call
    setTimeout(() => {
        window.location.reload();
    }, 1500);
}

function generateReport() {
    showToast('info', 'Generating report...');
    
    // In a real app, this would call an API to generate a report
    setTimeout(() => {
        const link = document.createElement('a');
        link.href = '/api/reports/dashboard';
        link.target = '_blank';
        link.click();
        showToast('success', 'Report generated successfully');
    }, 2000);
}

function requestSupport() {
    if (confirm('Would you like to contact your supervisor for support?')) {
        window.location.href = '/system/support?type=technical';
    }
}

function startAutoRefresh() {
    // Auto-refresh every 5 minutes (300000ms)
    setTimeout(() => {
        if (confirm('Dashboard data might be outdated. Refresh now?')) {
            window.location.reload();
        }
    }, 300000);
}

function showNotificationToast() {
    const notificationCount = {{notifications.length}};
    if (notificationCount > 0) {
        showToast('info', `You have ${notificationCount} new notification${notificationCount > 1 ? 's' : ''}`);
    }
}

// Helper function to show toast messages
function showToast(type, message) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed bottom-0 end-0 m-3`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', function () {
        document.body.removeChild(toast);
    });
}

// Add Handlebars helper functions to global scope for use in templates
window.getActivityIcon = function(type) {
    const icons = {
        'assignment': 'tasks',
        'verification': 'check-circle',
        'user': 'user',
        'system': 'cog',
        'error': 'exclamation-triangle',
        'success': 'check'
    };
    return icons[type] || 'circle';
};

window.getActivityColor = function(type) {
    const colors = {
        'assignment': 'primary',
        'verification': 'success',
        'user': 'info',
        'system': 'warning',
        'error': 'danger',
        'success': 'success'
    };
    return colors[type] || 'secondary';
};

window.formatTimeAgo = function(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
};
</script>