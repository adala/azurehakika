<div class="container-fluid py-4">
    <div class="content-header">
        <h1 class="h3">
            <i class="fas fa-globe"></i> Institutions Management
        </h1>
        <p class="text-muted">Manage supported institutions</p>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Supported Institutions</h5>
                    <button class="btn btn-primary btn-sm" id="addCountryBtn">
                        <i class="fas fa-plus"></i> Add Institution
                    </button>
                </div>
                <div class="card-body">
                    <div id="countriesList">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Institution Modal -->
<div class="modal fade" id="countryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="countryModalTitle">Add Institution</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="countryForm">
                    {{!-- <div class="mb-3">
                        <label for="countryName" class="form-label">Institution Name</label>
                        <input type="text" class="form-control" id="countryName" required>
                    </div>
                    <div class="mb-3">
                        <label for="countryCode" class="form-label">Country Code (ISO)</label>
                        <input type="text" class="form-control" id="countryCode" maxlength="3" required>
                    </div> --}}
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="isActive">
                        <label class="form-check-label" for="isActive">
                            Activate
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCountryBtn">Save Institution</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    loadCountries();
    
    document.getElementById('addCountryBtn').addEventListener('click', function() {
        showInstitutionModal();
    });
    
    document.getElementById('saveCountryBtn').addEventListener('click', saveInstitution);
});

async function loadCountries() {
    try {
        const response = await axios.get('/admin/institutions');
       
        const institutions = response.data.data;
        
        const institutionsList = document.getElementById('countriesList');
        
        if (institutions.length === 0) {
            institutionsList.innerHTML = '<div class="text-center py-4"><p class="text-muted">No countries found</p></div>';
            return;
        }
        
        let html = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Code</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        institutions.forEach(institution => {
            html += `
                <tr>
                    <td>${institution.name}</td>
                    <td><span class="badge bg-secondary">${institution.abbr}</span></td>
                    <td>
                        <span class="badge ${institution.is_active ? 'bg-success' : 'bg-secondary'}">
                            ${institution.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editInstitution('${institution.id}', '${institution.name}', '${institution.abbr}', ${institution.is_active})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteInstitution('${institution.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        institutionsList.innerHTML = html;
    } catch (error) {
        console.error('Error loading countries:', error);
        document.getElementById('countriesList').innerHTML = '<div class="alert alert-danger">Error loading countries</div>';
    }
}

function showInstitutionModal(institution = null) {
    const modal = new bootstrap.Modal(document.getElementById('countryModal'));
    const form = document.getElementById('countryForm');
    const title = document.getElementById('countryModalTitle');
    
    form.reset();
    
    if (institution) {
        title.textContent = 'Edit Institution';
       // document.getElementById('countryName').value = institution.name;
        //document.getElementById('countryCode').value = institution.abbr;
        document.getElementById('isActive').checked = institution.isActive;
        form.dataset.editId = institution.id;
    } else {
        title.textContent = 'Add Institution';
        delete form.dataset.editId;
    }
    
    modal.show();
}

async function saveInstitution() {
    const form = document.getElementById('countryForm');
    const name = document.getElementById('countryName').value;
    const code = document.getElementById('countryCode').value;
    const is_active = document.getElementById('isActive').checked;
    
    if (!name || !code) {
        alert('Please fill in all required fields');
        return;
    }
    
    try {
        const countries = await axios.get('/api/config/countries');
        let updatedInstitutions = countries.data.data;
        
        if (form.dataset.editId) {
            // Update existing country
            updatedInstitutions = updatedInstitutions.map(institution => 
                institution.id === form.dataset.editId 
                    ? { ...institution, name, abbr, is_active: is_active }
                    : institution
            );
        } else {
            // Add new country
            const newCountry = {
                id: Date.now().toString(),
                name,
                code: code.toUpperCase(),
                is_active: is_active
            };
            updatedInstitutions.push(newCountry);
        }
        
        await axios.put('/api/config/institutions', { institutions: updatedInstitutions });
        
        bootstrap.Modal.getInstance(document.getElementById('countryModal')).hide();
        loadCountries();
        
    } catch (error) {
        console.error('Error saving institution:', error);
        alert('Error saving institution');
    }
}

function editInstitution(id, name, code, is_active) {
    showInstitutionModal({ id, name, code, is_active });
}

async function deleteInstitution(id) {
    if (!confirm('Are you sure you want to delete this institution?')) {
        return;
    }
    
    try {
        const institutionsResponse = await axios.get('/api/config/institutions');
        const updatedInstitutions = institutionsResponse.data.data.filter(institution => institution.id !== id);
        
        await axios.put('/api/config/institutions', { institutions: updatedInstitutions });
        loadCountries();
        
    } catch (error) {
        console.error('Error deleting institutions:', error);
        alert('Error deleting institution');
    }
}
</script>